<dom-module id="route-edition">
  <template>
    <style is="custom-style" include="shared-styles"></style>
    <style>
      hr {
        margin: 0 5%;
        border-color: var(--primary-color);
      }

      .container {
        margin-bottom: 40px;
      }

      .item {
        padding: 12px 5% 0;
        @apply(--layout-horizontal);
        font-size: 1.05em;
        color: var(--secondary-text-color);
      }

      .item.no-padding {
        padding: 0;
      }

      .header {
        padding: 20px 5% 18px;
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1.4em;
      }

      .route-code {
        width: 15%;
        padding: 0 20px 0 0;
        font-weight: bold;
      }

      .route-details,
      .column2 {
        @apply(--layout-flex);
      }

      .column1 {
        width: 35%;
        padding: 0 20px 0 0;
      }

      .column-container {
        width: 35%;
      }

      .operations {
        text-transform: capitalize;
        text-align: right;
      }

      .edit-route-operation {
        padding: 21px 5%;
        font-size: 1.4em;
      }

      .delete-route{
        font-size: 0.5em;
        text-align: left;
        float:left;
        color: var(--secondary-color);
        top: 5px;
      }

      paper-button {
        top: 2px;
        padding: 0;
        background-color: transparent;
        color: var(--secondary-text-color);
      }

      paper-button.primary {
        color: var(--primary-color);
      }

      .direction-wrapper {
        margin-bottom: 20px;
      }

      stop-list {
        margin-bottom: 10px;
      }

      .add-stop-wrapper {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
      }

      .add-stop-wrapper paper-button {
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        padding: 0.5em 1em;
      }

      google-map {
        height: 300px;
      }

      #stopsModal {
        width: 50%;
      }

      .buttons paper-button {
        padding: 10px 15px;
      }

      #saveOperationResultModal {
        width: auto;
        background-color: transparent;
        color: var(--vta-white);
        box-shadow: none;
      }

      #saveOperationResultModal .icon {
        text-align: center;
      }

      #saveOperationResultModal iron-icon {
        width: 140px;
        height: 140px;
        padding: 20px;
        text-align: center;
        -webkit-border-radius: 50%;
        border-radius: 50%;
      }

      #saveOperationResultModal .message-wrapper.success iron-icon {
        background-color: var(--primary-color);
      }

      #saveOperationResultModal .message-wrapper.error iron-icon {
        background-color: var(--secondary-color);
      }

      #saveOperationResultModal .message {
        text-align: center;
        font-size: 2.5em;
        line-height: 1;
        text-transform: uppercase;
        font-weight: bold;
        margin-top: 10px;
      }
      .routeInfo{
        padding-left: 0px;
        margin-left: 5%;
      }
      .main-heading{
        margin-left: 5%;
    margin-top: 2%;
    font-weight: bold;
      }
    </style>

    <firebase-query
      app-name="vta"
      id="stops"
      path="/stops"
      data="{{_stopsOrigin}}">
    </firebase-query>
    <firebase-document
      app-name="vta"
      id="routeInfo"
      data="{{_routeInfoOrigin}}">
    </firebase-document>
    <firebase-document
      app-name="vta"
      id="routeDetails"
      data="{{_routeDetailsOrigin}}">
    </firebase-document>

    <div class="inner-content">
      <template is="dom-if" if="{{_isNewRoute}}">
        <h2 class="page-title">New route</h2>
      </template>
      <template is="dom-if" if="{{!_isNewRoute}}">
        <h2 class="page-title">Edit route</h2>
      </template>

      <paper-material elevation="1">
        <div class="item header">
          <div class="column1">
            <div class="item no-padding">
              <div class="route-code">Code</div>
              <div class="route-details">Route name</div>
            </div>
          </div>
          <div class="column2">
            <div class="operations">
              <!-- <a href="{{baseUrl}}routes" tabindex="-1">
                <paper-button>Cancel</paper-button>
              </a> -->
              <!-- <paper-button class="primary" on-click="_captureRouteData">Save</paper-button> -->
            </div>
          </div>
        </div>

        <hr/>

        <div class="item">
          <div class="column1">
            <div class="item no-padding">
              <div class="route-code">
                <paper-input id="code" value="{{_code}}" placeholder="Number" required></paper-input>
              </div>
              <div class="route-details">
                <paper-input id="name" value="{{_routeInfo.name}}" placeholder="Text" required></paper-input>
              </div>
            </div>

            <paper-input id="departure" value="{{_routeInfo.departure}}" label="Departure" placeholder="Text" required></paper-input>
            <paper-input id="destination" value="{{_routeInfo.destination}}" label="Destination" placeholder="Text" required></paper-input>
            <paper-input id="latitude" value="{{_routeInfo.latitude}}" label="Latitude" placeholder="Text" required></paper-input>
            <paper-input id="longitude" value="{{_routeInfo.longitude}}" label="Longitude" placeholder="Text" required></paper-input>

          </div>
          <div class="column2">
            <paper-dropdown-menu id="mapViewDropdown" label="Map View" vertical-align="bottom" horizontal-align="left" on-iron-select="_changeMapView">
               <paper-listbox id="directionDropdownListBox" slot="dropdown-content" class="dropdown-content" selected="0">
                   <template is="dom-if" if="[[_routeDetails.a.videoGeoPoints]]">
                      <paper-item value="a">Direction A</paper-item>
                   </template>
                   <template is="dom-if" if="[[_routeDetails.b.videoGeoPoints]]">
                    <paper-item value="b">Direction B</paper-item>
                  </template>
                </paper-listbox>
          </paper-dropdown-menu>
            <!-- <select id="mapDirectionSelection">
              <option  value="a"> Direction A </option>
              <option  value="b"> Direction B </option>
            </select> -->
            <template is="dom-if" if="[[_videoGeoPoints]]">
            <route-map id="routeMap" geo-points="{{_videoGeoPoints}}"></route-map>
            </template>
          </div>
        </div>
        <h3 class="main-heading">High Resolution</h3><br/>
        <div class="container item routeInfo">
          <div class="column1">
            <h3>Direction A - Info</h3>
            <paper-input id="directionAName" value="{{_routeInfo.directionAName}}" placeholder="Direction A Name" required></paper-input>
            <paper-input id="videoA" value="{{_routeDetails.a.videoUrl}}" label="Video Direction A - Front" placeholder="Front Video URL" required></paper-input>
            <paper-input id="videoALeft" value="{{_routeDetails.a.videoLeftUrl}}" label="Video Direction A - Left" placeholder="Left Side Video URL" required></paper-input>
            <paper-input id="videoARight" value="{{_routeDetails.a.videoRightUrl}}" label="Video Direction A - Right" placeholder="Right Side Video URL" required></paper-input>
            <paper-input id="videoABack" value="{{_routeDetails.a.videoBackUrl}}" label="Video Direction A - Back" placeholder="Back Side Video URL" required></paper-input>
            <paper-input id="videoANight" value="{{_routeDetails.a.videoNightUrl}}" label="Video Direction A - Night" placeholder="Night Video URL" required></paper-input>
            <paper-input id="kmlFileA" label="KML File Direction A Front view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChange"></paper-input>
            <paper-input id="kmlFileALeft" label="KML File Direction A Left view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeLeft"></paper-input>
            <paper-input id="kmlFileARight" label="KML File Direction A Right view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeRight"></paper-input>
            <paper-input id="kmlFileABack" label="KML File Direction A Back view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeBack"></paper-input>
            <paper-input id="kmlFileANight" label="KML File Direction A Night view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeNight"></paper-input>

          </div>
          <div class="column1">
            <h3>Direction B - Info</h3>
            <paper-input id="directionBName" value="{{_routeInfo.directionBName}}" placeholder="Direction B Name" required></paper-input>
            <paper-input id="videoB" value="{{_routeDetails.b.videoUrl}}" label="Video Direction B - Front" placeholder="Front Video URL" required></paper-input>
            <paper-input id="videoBLeft" value="{{_routeDetails.b.videoLeftUrl}}" label="Video Direction B - Left" placeholder="Left Side Video URL" required></paper-input>
            <paper-input id="videoBRight" value="{{_routeDetails.b.videoRightUrl}}" label="Video Direction B - Right" placeholder="Right Side Video URL" required></paper-input>
            <paper-input id="videoBBack" value="{{_routeDetails.b.videoBackUrl}}" label="Video Direction B - Back" placeholder="Back Side Video URL" required></paper-input>
            <paper-input id="videoBNight" value="{{_routeDetails.b.videoNightUrl}}" label="Video Direction B - Night" placeholder="Night Video URL" required></paper-input>
            <paper-input id="kmlFileB" label="KML File Direction B Front View" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChange"></paper-input>
            <paper-input id="kmlFileBLeft" label="KML File Direction B Left view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChangeLeft"></paper-input>
            <paper-input id="kmlFileBRight" label="KML File Direction B Right view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChangeRight"></paper-input>
            <paper-input id="kmlFileBBack" label="KML File Direction B Back view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChangeBack"></paper-input>
            <paper-input id="kmlFileBNight" label="KML File Direction B Night view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChangeNight"></paper-input>


          </div>
        </div>
        <hr/>
        <h3 class="main-heading">Low Resolution</h3><br/>
        <div class="container item routeInfo">
          <div class="column1">
            <h3>Direction A - Info</h3>
            <paper-input id="videoALowRes" value="{{_routeDetails.a.videoUrlLowRes}}" label="Video Direction A - Front" placeholder="Front Video URL" required></paper-input>
            <paper-input id="videoALeftLowRes" value="{{_routeDetails.a.videoLeftUrlLowRes}}" label="Video Direction A - Left" placeholder="Left Side Video URL" required></paper-input>
            <paper-input id="videoARightLowRes" value="{{_routeDetails.a.videoRightUrlLowRes}}" label="Video Direction A - Right" placeholder="Right Side Video URL" required></paper-input>
            <paper-input id="videoABackLowRes" value="{{_routeDetails.a.videoBackUrlLowRes}}" label="Video Direction A - Back" placeholder="Back Side Video URL" required></paper-input>
            <paper-input id="videoANightLowRes" value="{{_routeDetails.a.videoNightUrlLowRes}}" label="Video Direction A - Night" placeholder="Night Video URL" required></paper-input>
            <paper-input id="kmlFileALowRes" label="KML File Direction A Front view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeLowRes"></paper-input>
            <paper-input id="kmlFileALeftLowRes" label="KML File Direction A Left view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeLeftLowRe"></paper-input>
            <paper-input id="kmlFileARightLowRes" label="KML File Direction A Right view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeRightLowRes"></paper-input>
            <paper-input id="kmlFileABackLowRes" label="KML File Direction A Back view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeBackLowRes"></paper-input>
            <paper-input id="kmlFileANightLowRes" label="KML File Direction A Night view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileAChangeNightLowRes"></paper-input>
            <template is="dom-if" if="{{_displayStops}}">
              <div class="stops-wrapper">
                <h3>Direction A - Stops</h3>
                <stop-list stops="{{_routeDetails.a.stops}}" show-operations></stop-list>
                <div class="add-stop-wrapper">
                  <paper-button on-click="_openAddStopModal" data-route-direction="a">
                    <iron-icon icon="icons:add"></iron-icon>Add stop
                  </paper-button>
                </div>
              </div>
            </template>
          </div>
          <div class="column1">
            <h3>Direction B - Info</h3>
            <paper-input id="videoBLowRes" value="{{_routeDetails.b.videoUrlLowRes}}" label="Video Direction B - Front" placeholder="Front Video URL" required></paper-input>
            <paper-input id="videoBLeftLowRes" value="{{_routeDetails.b.videoLeftUrlLowRes}}" label="Video Direction B - Left" placeholder="Left Side Video URL" required></paper-input>
            <paper-input id="videoBRightLowRes" value="{{_routeDetails.b.videoRightUrlLowRes}}" label="Video Direction B - Right" placeholder="Right Side Video URL" required></paper-input>
            <paper-input id="videoBBackLowRes" value="{{_routeDetails.b.videoBackUrlLowRes}}" label="Video Direction B - Back" placeholder="Back Side Video URL" required></paper-input>
            <paper-input id="videoBNightLowRes" value="{{_routeDetails.b.videoNightUrlLowRes}}" label="Video Direction B - Night" placeholder="Night Video URL" required></paper-input>
            <paper-input id="kmlFileBLowRes" label="KML File Direction B Front View" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChange"></paper-input>
            <paper-input id="kmlFileBLeftLowRes" label="KML File Direction B Left view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChangeLeftLowRes"></paper-input>
            <paper-input id="kmlFileBRightLowRes" label="KML File Direction B Right view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChangeRightLowRes"></paper-input>
            <paper-input id="kmlFileBBackLowRes" label="KML File Direction B Back view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChangeBackLowRes"></paper-input>
            <paper-input id="kmlFileBNightLowRes" label="KML File Direction B Night view" type="file" placeholder="File with the Geo Video points" on-change="_onKmlFileBChangeNightLowRes"></paper-input>

            <template is="dom-if" if="{{_displayStops}}">
              <div class="stops-wrapper">
                <h3>Direction B - Stops</h3>
                <stop-list stops="{{_routeDetails.b.stops}}" show-operations></stop-list>
                <!-- <div class="add-stop-wrapper">
                  <paper-button on-click="_openAddStopModal" data-route-direction="b">
                    <iron-icon icon="icons:add"></iron-icon>Add stop
                  </paper-button>
                </div> -->
              </div>
            </template>
          </div>
        </div>
      <hr/>


        <div class="operations edit-route-operation">
          <paper-button class="delete-route" on-click="_openDeleteRouteModal">Delete This Route</paper-button>
          <a href="{{baseUrl}}routes" tabindex="-1">
            <paper-button>Cancel</paper-button>
          </a>
          <paper-button class="primary" on-click="_captureRouteData">Save</paper-button>
        </div>
      </paper-material>
    </div>

    <kml-parser id="kmlParserA" result="{{_kmlParserAResult}}"></kml-parser>
    <kml-parser id="kmlParserALeft" result="{{_kmlParserAResultLeft}}"></kml-parser>
    <kml-parser id="kmlParserARight" result="{{_kmlParserAResultRight}}"></kml-parser>
    <kml-parser id="kmlParserARight" result="{{_kmlParserAResultRight}}"></kml-parser>
    <kml-parser id="kmlParserABack" result="{{_kmlParserAResultBack}}"></kml-parser>
    <kml-parser id="kmlParserALowRes" result="{{_kmlParserAResultLowRes}}"></kml-parser>
    <kml-parser id="kmlParserALeftLowRes" result="{{_kmlParserAResultLeftLowRes}}"></kml-parser>
    <kml-parser id="kmlParserARightLowRes" result="{{_kmlParserAResultRightLowRes}}"></kml-parser>
    <kml-parser id="kmlParserARightLowRes" result="{{_kmlParserAResultRightLowRes}}"></kml-parser>
    <kml-parser id="kmlParserABackLowRes" result="{{_kmlParserAResultBackLowRes}}"></kml-parser>



    <kml-parser id="kmlParserB" result="{{_kmlParserBResult}}"></kml-parser>
    <kml-parser id="kmlParserBLeft" result="{{_kmlParserBResultLeft}}"></kml-parser>
    <kml-parser id="kmlParserBRight" result="{{_kmlParserBResultRight}}"></kml-parser>
    <kml-parser id="kmlParserBBack" result="{{_kmlParserBResultBack}}"></kml-parser>
    <kml-parser id="kmlParserBNight" result="{{_kmlParserBResultNight}}"></kml-parser>

    <kml-parser id="kmlParserBLowRes" result="{{_kmlParserBResultLowRes}}"></kml-parser>
    <kml-parser id="kmlParserBLeftLowRes" result="{{_kmlParserBResultLeftLowRes}}"></kml-parser>
    <kml-parser id="kmlParserBRightLowRes" result="{{_kmlParserBResultRightLowRes}}"></kml-parser>
    <kml-parser id="kmlParserBBackLowRes" result="{{_kmlParserBResultBackLowRes}}"></kml-parser>
    <kml-parser id="kmlParserBNightLowRes" result="{{_kmlParserBResultNightLowRes}}"></kml-parser>

    <paper-dialog id="stopsModal" modal>
      <paper-input-autocomplete id="stopAutocompleteA" label="Stop" placeholder="Type your stop"
          search-property="backofficeName" value="{{_selectedStop}}" source={{_stopsOrigin}} suggestions-in-overlay="true"
          autocomplete-search-length="5">
      </paper-input-autocomplete>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus class="primary" on-click="_addStop">Add</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="saveOperationResultModal" modal>
      <template is="dom-if" if="{{_operationSuccess}}">
        <div class="message-wrapper success">
          <div class="icon">
            <iron-icon icon="icons:check"></iron-icon>
          </div>
          <div class="message">Saved</div>
        </div>
      </template>
      <template is="dom-if" if="{{!_operationSuccess}}">
        <div class="message-wrapper error">
          <div class="icon">
            <iron-icon icon="icons:clear"></iron-icon>
          </div>
          <div class="message">Error</div>
          <div class="">{{_operationMessageDetail}}</div>
        </div>
      </template>
    </paper-dialog>

    <paper-dialog id="deleteRouteModal" modal>
      <h2>Delete this route</h2>
      <div class="message">Do you want to delete route {{_code}} {{_routeInfo.name}}?</div>

      <div class="buttons">
        <paper-button dialog-dismiss>No</paper-button>
        <paper-button dialog-confirm autofocus class="primary" on-click="_deleteRoute">Yes, delete route</paper-button>
      </div>
    </paper-dialog>

    <maps-utils id="mapsUtils"></maps-utils>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'route-edition',

      properties: {
        _stops: {
          type: Array
        },
        _isNewRoute: {
          type: Boolean,
          value: true
        },
        code: {
          type: String,
          value: null,
          observer: '_codeChange'
        },
        _routeInfoOrigin: {
          type: Object,
          observer: '_routeInfoOriginChange'
        },
        _routeInfo: {
          type: Object,
          value: {}
        },
        _routeDetailsOrigin: {
          type: Object,
          observer: '_routeDetailsOriginChange'
        },
        _routeDetails: {
          type: Object,
          value: {
            a: {
              stops: [],
              videoGeoPoints: {},
              videoId: null,
              videoUrl: null,
              videoLeftUrl: null,
              videoRightUrl: null,
              videoBackUrl: null,
              videoNightUrl: null,
            },
            b: {
              stops: [],
              videoGeoPoints: {},
              videoId: null,
              videoUrl: null,
              videoLeftUrl: null,
              videoRightUrl: null,
              videoBackUrl: null,
              videoNightUrl: null,
            }
          }
        },
        _kmlParserAResult: {
          type: Object,
          observer: '_kmlParserAResultChange'
        },
        _kmlParserAResultLeft: {
          type: Object,
          observer: '_kmlParserAResultChangeLeft'
        },
        _kmlParserAResultRight: {
          type: Object,
          observer: '_kmlParserAResultChangeRight'
        },
        _kmlParserAResultBack: {
          type: Object,
          observer: '_kmlParserAResultChangeBack'
        },
        _kmlParserAResultNight: {
          type: Object,
          observer: '_kmlParserAResultChangeNight'
        },
        _kmlParserAResultLowRes: {
          type: Object,
          observer: '_kmlParserAResultChangeLowRes'
        },
        _kmlParserAResultLeftLowRes: {
          type: Object,
          observer: '_kmlParserAResultChangeLeftLowRes'
        },
        _kmlParserAResultRightLowRes: {
          type: Object,
          observer: '_kmlParserAResultChangeRightLowRes'
        },
        _kmlParserAResultBackLowRes: {
          type: Object,
          observer: '_kmlParserAResultChangeBackLowRes'
        },
        _kmlParserAResultNightLowRes: {
          type: Object,
          observer: '_kmlParserAResultChangeNightLowRes'
        },


        _kmlParserBResult: {
          type: Object,
          observer: '_kmlParserBResultChange'
        },
        _kmlParserBResultLeft: {
          type: Object,
          observer: '_kmlParserBResultChangeLeft'
        },
        _kmlParserBResultRight: {
          type: Object,
          observer: '_kmlParserBResultChangeRight'
        },
        _kmlParserBResultBack: {
          type: Object,
          observer: '_kmlParserBResultChangeBack'
        },
        _kmlParserBResultNight: {
          type: Object,
          observer: '_kmlParserBResultChangeNight'
        },
        _kmlParserBResultLowRes: {
          type: Object,
          observer: '_kmlParserBResultChangeLowRes'
        },
        _kmlParserBResultLeftLowRes: {
          type: Object,
          observer: '_kmlParserBResultChangeLeftLowRes'
        },
        _kmlParserBResultRightLowRes: {
          type: Object,
          observer: '_kmlParserBResultChangeRightLowRes'
        },
        _kmlParserBResultBackLowRes: {
          type: Object,
          observer: '_kmlParserBResultChangeBackLowRes'
        },
        _kmlParserBResultNightLowRes: {
          type: Object,
          observer: '_kmlParserBResultChangeNightLowRes'
        },
        _displayStops: {
          type: Boolean,
          value: true
        },
        _map : {
          type: Object
        },
      },

      clear: function() {
        var baseRouteDetails = {
          a: {
            stops: [],
            videoGeoPoints: {},
            videoId: null,
            videoUrl: null
          },
          b: {
            stops: [],
            videoGeoPoints: {},
            videoId: null,
            videoUrl: null
          }
        };

        this._code = null;
        this.$.kmlFileA.value = '';
        this.$.kmlFileA.type = '';
        this.$.kmlFileA.type = 'file';
        this.$.kmlFileB.value = '';
        this.$.kmlFileB.type = '';
        this.$.kmlFileB.type = 'file';
        this.$.routeInfo.reset();
        this.$.routeDetails.reset();
        this._routeInfo = {};
        this._routeDetails = baseRouteDetails;
        this._displayStops = false;
        this._isNewRoute = true;
        this._videoGeoPoints = null;
      },

      _codeChange: function(newCode) {
        if (newCode) { // A route will be edited
          var self = this;
          this._code = newCode;
          this._isNewRoute = false;

          this.$.routeInfo.getStoredValue('/routes/' + newCode)
            .then(function(data) {
              self._routeInfoOrigin = data;

              return self.$.routeDetails.getStoredValue('/route-details/' + newCode);
            }).then(function(data) {
              self._routeDetailsOrigin = data;
              if(self._routeDetailsOrigin && self._routeDetailsOrigin.a && self._routeDetailsOrigin.a.videoGeoPoints){
                self._videoGeoPoints = self._routeDetailsOrigin.a.videoGeoPoints;
              }else if(self._routeDetailsOrigin && self._routeDetailsOrigin.b && self._routeDetailsOrigin.b.videoGeoPoints){
                self._videoGeoPoints = self._routeDetailsOrigin.b.videoGeoPoints;
              }

              self._displayStops = true;
            }).catch(function(error) {
              console.log(error);
            });
        } else {
          this.clear();
        }
      },
      _getDropdownSelectedValue : function(event) {
        var selectedItem = $(event.target.selectedItem)[0];
        if (selectedItem) {
          return $(selectedItem).attr('value');
        } else {
          return null;
        }
      },
      _changeMapView: function(event) {
          var selectedView = this._getDropdownSelectedValue(event);
          if(selectedView && this._routeDetailsOrigin && this._routeDetailsOrigin[selectedView] &&  this._routeDetailsOrigin[selectedView].videoGeoPoints){
            this._videoGeoPoints = this._routeDetailsOrigin[selectedView].videoGeoPoints;
          }


        },

      _routeInfoOriginChange: function(newRouteInfo) {
        if (this._jsonHasKeys(newRouteInfo)) {
          this._routeInfo = newRouteInfo;
        }
      },
      _setDefaultLatLng:function(lat,lng){
        console.log(lat,lng);
        this._routeInfo.latitude = lat;
        this._routeInfo.longitude = lng;
      },
      _routeDetailsOriginChange: function(newRouteDetails) {
        if (this._jsonHasKeys(newRouteDetails)) {
          this._routeDetails = newRouteDetails;
        }
      },

      _onKmlFileAChange: function(event) {
        this._kmlFileA = event.target.files[0];

        if (this._kmlFileA) {
          this.$.kmlParserA.file = this._kmlFileA;
          this.$.kmlParserA.parse();
        }
      },
      _onKmlFileAChangeLeft: function(event) {
        this._kmlFileALeft = event.target.files[0];

        if (this._kmlFileALeft) {
          this.$.kmlParserALeft.file = this._kmlFileALeft;
          this.$.kmlParserALeft.parse();
        }
      },
      _onKmlFileAChangeRight: function(event) {
        this._kmlFileARight = event.target.files[0];

        if (this._kmlFileARight) {
          this.$.kmlParserARight.file = this._kmlFileARight;
          this.$.kmlParserARight.parse();
        }
      },
      _onKmlFileAChangeBack: function(event) {
        this._kmlFileABack = event.target.files[0];

        if (this._kmlFileABack) {
          this.$.kmlParserABack.file = this._kmlFileABack;
          this.$.kmlParserABack.parse();
        }
      },
      _onKmlFileAChangeNight: function(event) {
        this._kmlFileANight = event.target.files[0];

        if (this._kmlFileANight) {
          this.$.kmlParserANight.file = this._kmlFileANight;
          this.$.kmlParserANight.parse();
        }
      },
      _onKmlFileAChangeLowRes: function(event) {
        this._kmlFileALowRes = event.target.files[0];

        if (this._kmlFileALowRes) {
          this.$.kmlParserALowRes.file = this._kmlFileALowRes;
          this.$.kmlParserALowRes.parse();
        }
      },
      _onKmlFileAChangeLeftLowRes: function(event) {
        this._kmlFileALeftLowRes = event.target.files[0];

        if (this._kmlFileALeftLowRes) {
          this.$.kmlParserALeftLowRes.file = this._kmlFileALeftLowRes;
          this.$.kmlParserALeftLowRes.parse();
        }
      },
      _onKmlFileAChangeRightLowRes: function(event) {
        this._kmlFileARightLowRes = event.target.files[0];

        if (this._kmlFileARightLowRes) {
          this.$.kmlParserARightLowRes.file = this._kmlFileARightLowRes;
          this.$.kmlParserARightLowRes.parse();
        }
      },
      _onKmlFileAChangeBackLowRes: function(event) {
        this._kmlFileABackLowRes = event.target.files[0];

        if (this._kmlFileABackLowRes) {
          this.$.kmlParserABackLowRes.file = this._kmlFileABack;
          this.$.kmlParserABackLowRes.parse();
        }
      },
      _onKmlFileAChangeNightLowRes: function(event) {
        this._kmlFileANightLowRes = event.target.files[0];

        if (this._kmlFileANightLowRes) {
          this.$.kmlParserANightLowRes.file = this._kmlFileANightLowRes;
          this.$.kmlParserANightLowRes.parse();
        }
      },

      _onKmlFileBChange: function(event) {
        this._kmlFileB = event.target.files[0];

        if (this._kmlFileB) {
          this.$.kmlParserB.file = this._kmlFileB;
          this.$.kmlParserB.parse();
        }
      },
      _onKmlFileBChangeLeft: function(event) {
        this._kmlFileBLeft = event.target.files[0];

        if (this._kmlFileBLeft) {
          this.$.kmlParserBLeft.file = this._kmlFileBLeft;
          this.$.kmlParserBLeft.parse();
        }
      },
      _onKmlFileBChangeRight: function(event) {
        this._kmlFileBRight = event.target.files[0];

        if (this._kmlFileBRight) {
          this.$.kmlParserBRight.file = this._kmlFileBRight;
          this.$.kmlParserBRight.parse();
        }
      },
      _onKmlFileBChangeBack: function(event) {
        this._kmlFileBBack = event.target.files[0];

        if (this._kmlFileBBack) {
          this.$.kmlParserBBack.file = this._kmlFileBBack;
          this.$.kmlParserBBack.parse();
        }
      },
      _onKmlFileBChangeNight: function(event) {
        this._kmlFileBNight = event.target.files[0];

        if (this._kmlFileBNight) {
          this.$.kmlParserBNight.file = this._kmlFileBNight;
          this.$.kmlParserBNight.parse();
        }
      },
      _onKmlFileBChangeLowRes: function(event) {
        this._kmlFileBLowRes = event.target.files[0];

        if (this._kmlFileBLowRes) {
          this.$.kmlParserBLowRes.file = this._kmlFileBLowRes;
          this.$.kmlParserBLowRes.parse();
        }
      },
      _onKmlFileBChangeLeftLowRes: function(event) {
        this._kmlFileBLeftLowRes = event.target.files[0];

        if (this._kmlFileBLeftLowRes) {
          this.$.kmlParserBLeftLowRes.file = this._kmlFileBLeftLowRes;
          this.$.kmlParserBLeftLowRes.parse();
        }
      },
      _onKmlFileBChangeRightLowRes: function(event) {
        this._kmlFileBRightLowRes = event.target.files[0];

        if (this._kmlFileBRightLowRes) {
          this.$.kmlParserBRightLowRes.file = this._kmlFileBRightLowRes;
          this.$.kmlParserBRightLowRes.parse();
        }
      },
      _onKmlFileBChangeBackLowRes: function(event) {
        this._kmlFileBBackLowRes = event.target.files[0];

        if (this._kmlFileBBackLowRes) {
          this.$.kmlParserBBackLowRes.file = this._kmlFileBBack;
          this.$.kmlParserBBackLowRes.parse();
        }
      },
      _onKmlFileBChangeNightLowRes: function(event) {
        this._kmlFileBNightLowRes = event.target.files[0];

        if (this._kmlFileBNightLowRes) {
          this.$.kmlParserBNightLowRes.file = this._kmlFileBNightLowRes;
          this.$.kmlParserBNightLowRes.parse();
        }
      },

      _kmlParserAResultChange: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }

        this._routeDetails.a.videoGeoPoints = newKmlParserResultChange;

        // notifyPath method is used to notify the change of the inner object
        this.notifyPath('_routeDetails.a.videoGeoPoints', newKmlParserResultChange);
        this._checkVideoGeoPoints();
      },
      _kmlParserAResultChangeLeft: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }
        this._routeDetails.a.videoGeoPointsLeft = newKmlParserResultChange;
      },
      _kmlParserAResultChangeRight: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }
        this._routeDetails.a.videoGeoPointsRight = newKmlParserResultChange;
      },
      _kmlParserAResultChangeBack: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }
        this._routeDetails.a.videoGeoPointsBack = newKmlParserResultChange;
      },
      _kmlParserAResultChangeNight: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }
        this._routeDetails.a.videoGeoPointsNight = newKmlParserResultChange;
      },
      _kmlParserAResultChangeLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }

        this._routeDetails.a.videoGeoPointsLowRes = newKmlParserResultChange;
      },
      _kmlParserAResultChangeLeftLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }
        this._routeDetails.a.videoGeoPointsLeftLowRes = newKmlParserResultChange;
      },
      _kmlParserAResultChangeRightLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }
        this._routeDetails.a.videoGeoPointsRightLowRes = newKmlParserResultChange;
      },
      _kmlParserAResultChangeBackLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }
        this._routeDetails.a.videoGeoPointsBackLowRes = newKmlParserResultChange;
      },
      _kmlParserAResultChangeNightLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.a) {
          this._routeDetails.a = {};
        }
        this._routeDetails.a.videoGeoPointsNightLowRes = newKmlParserResultChange;
      },
      _kmlParserBResultChange: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }

        this._routeDetails.b.videoGeoPoints = newKmlParserResultChange;
        this._checkVideoGeoPoints();
      },
      _kmlParserBResultChangeLeft: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }
        this._routeDetails.b.videoGeoPointsLeft = newKmlParserResultChange;
      },
      _kmlParserBResultChangeRight: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }
        this._routeDetails.b.videoGeoPointsRight = newKmlParserResultChange;
      },
      _kmlParserBResultChangeBack: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }
        this._routeDetails.b.videoGeoPointsBack = newKmlParserResultChange;
      },
      _kmlParserBResultChangeNight: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }
        this._routeDetails.b.videoGeoPointsNight = newKmlParserResultChange;
      },
      _kmlParserBResultChangeLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }

        this._routeDetails.b.videoGeoPointsLowRes = newKmlParserResultChange;
      },
      _kmlParserBResultChangeLeftLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }
        this._routeDetails.b.videoGeoPointsLeftLowRes = newKmlParserResultChange;
      },
      _kmlParserBResultChangeRightLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }
        this._routeDetails.b.videoGeoPointsRightLowRes = newKmlParserResultChange;
      },
      _kmlParserBResultChangeBackLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }
        this._routeDetails.b.videoGeoPointsBackLowRes = newKmlParserResultChange;
      },
      _kmlParserBResultChangeNightLowRes: function(newKmlParserResultChange) {
        if (!this._routeDetails.b) {
          this._routeDetails.b = {};
        }
        this._routeDetails.b.videoGeoPointsNightLowRes = newKmlParserResultChange;
      },

      _checkVideoGeoPoints: function() {
        var videoGeoPointsA = this._routeDetails.a.videoGeoPoints;
        var videoGeoPointsB = this._routeDetails.b.videoGeoPoints;

        this._displayStops = this._jsonHasKeys(this._routeDetails.a.videoGeoPoints) &&
          this._jsonHasKeys(this._routeDetails.b.videoGeoPoints);
      },

      _openAddStopModal: function(e) {
        this._directionToAddStop = this._getClickedAddStopDirection(e);
        this.$.stopsModal.open();
      },

      _getClickedAddStopDirection: function(event) {
        var buttonElement = event.srcElement;

        if (buttonElement.localName === 'iron-icon') {
          buttonElement = buttonElement.parentElement;
        }

        return buttonElement.getAttribute('data-route-direction');
      },

      _addStop: function() {
        if (this._routeDetails[this._directionToAddStop].videoGeoPoints &&
            this._jsonHasKeys(this._routeDetails[this._directionToAddStop].videoGeoPoints)) {
          var newStop = this._getStopObj(this._selectedStop);

          // Get the closests point to the selected stop for the selected direction
          var point = this.$.mapsUtils.getClosestPoint(newStop.lat, newStop.lng, this._routeDetails[this._directionToAddStop].videoGeoPoints);

          var stopsPath = '_routeDetails.' + this._directionToAddStop + '.stops';
          var newStopPosition = 0;

          if (!this._routeDetails[this._directionToAddStop].stops) {
            this._routeDetails[this._directionToAddStop].stops = [];
            this.notifyPath(stopsPath);
          }

          newStop.sec = point.key;

          // Find the new stop position
          newStopPosition = this._findNewStopPosition(this._routeDetails[this._directionToAddStop].stops, newStop);

          // Add the new stop in the proper position
          this.splice(stopsPath, newStopPosition, 0, newStop);
        }
      },

      _findNewStopPosition: function(stopsList, newStop) {
        for (var indexStop = stopsList.length - 1; indexStop >= 0; indexStop--) {
          if ((newStop.sec - stopsList[indexStop].sec) > 0) {
            return indexStop + 1;
          }
        }
      },

      _captureRouteData: function() {
        // Check if the values are well included
        if (!this._validateForm()) {
          return;
        }

        this._routeInfo.code = this._code;

        if (this._routeDetails.a.videoUrl) {
          this._routeDetails.a.videoId = this._getYouTubeVideoId(this._routeDetails.a.videoUrl);
        }

        if (this._routeDetails.b.videoUrl) {
          this._routeDetails.b.videoId = this._getYouTubeVideoId(this._routeDetails.b.videoUrl);
        }

        this._saveRoute();
      },

      _validateForm: function() {
        var fields = [
          this.$.code,
          this.$.name,
          // this.$.videoA,
          // this.$.videoALeft,
          // this.$.videoARight,
          // this.$.videoABack,
          // this.$.videoANight,
          // this.$.videoB,
          // this.$.videoBLeft,
          // this.$.videoBRight,
          // this.$.videoBBack,
          // this.$.videoBNight,
          this.$.directionAName,
          this.$.directionBName,
          this.$.departure,
          this.$.destination
        ];

        var isFormValid = true;
        var actualValidation;

        // This allows the validation of all the fields at once
        for (var indexField = 0; indexField < fields.length; indexField++) {
          actualValidation = fields[indexField].validate();
          isFormValid = isFormValid && actualValidation;
        }

        isFormValid = isFormValid && this._routeDetails.a && this._jsonHasKeys(this._routeDetails.a.videoGeoPoints);
        isFormValid = isFormValid && this._routeDetails.b && this._jsonHasKeys(this._routeDetails.b.videoGeoPoints);

        return isFormValid;
      },

      _getYouTubeVideoId: function(videoUrl) {
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/;
        var match = videoUrl.match(regExp);

        if (match && match[7].length == 11) {
          return match[7];
        } else {
          return false;
        }
      },

      _saveRoute: function() {
        var self = this;

        console.log(this._routeDetails);
        console.log('above data is old one');
        if(!this._routeInfo.latitude && !this._routeInfo.longitude){
          if(this._routeDetails.a && this._routeDetails.a.videoGeoPoints && this._routeDetails.a.videoGeoPoints[1]){
            this._setDefaultLatLng (this._routeDetails.a.videoGeoPoints[1].lat, this._routeDetails.a.videoGeoPoints[1].lng);
          }
        }

        if(this._routeDetails.a && this._routeDetails.a.stops && this._routeDetails.a.stops.length ){
          for(var a=0;a<this._routeDetails.a.stops.length;a++){
            var tempStopObject = this._routeDetails.a.stops[a];
            if (tempStopObject.isNotificationEnabled === true) {
              this._routeDetails.a.stops[a].isNotificationEnabled = true;
            } else {
              this._routeDetails.a.stops[a].isNotificationEnabled = false;
            }
              var point = this.$.mapsUtils.getClosestPoint(tempStopObject.lat, tempStopObject.lng, this._routeDetails.a.videoGeoPoints);
              this._routeDetails.a.stops[a].sec =  parseInt(point.key);
          }
        }

        if(this._routeDetails.b && this._routeDetails.b.stops && this._routeDetails.b.stops.length ){
          for(var b=0;b<this._routeDetails.b.stops.length;b++){
            var tempStopObject = this._routeDetails.b.stops[b];
            if (tempStopObject.isNotificationEnabled === true) {
              this._routeDetails.b.stops[b].isNotificationEnabled = true;
            } else {
              this._routeDetails.b.stops[b].isNotificationEnabled = false;
            }
            var point = this.$.mapsUtils.getClosestPoint(tempStopObject.lat, tempStopObject.lng, this._routeDetails.b.videoGeoPoints);
            this._routeDetails.b.stops[b].sec =  parseInt(point.key);
          }
        }

        console.log(this._routeDetails);
        console.log('this is end of processing now going to save')
        this._routeInfoOrigin = this._routeInfo;
        this._routeDetailsOrigin = this._routeDetails;
        var code = this._routeInfo.code;
        var update = {};
        update['routes/'+code] = this._routeInfo;
        update['route-details/'+code] = this._routeDetails;
        console.log('check below update deep path data');
        console.log(update);
        var firebaseDb = this.$.routeInfo.db;
        var firebaseDbRef = firebaseDb.ref();
        firebaseDbRef.update(update, function(error) {
          if (error) {
            console.log("Error updating data:", error);
            self._showOperationResultModal(false, error);
          }else{
            console.log('Write Success');
              self._showOperationResultModal(true);
          }
        });

        //
        //
        // this.$.routeInfo.save('/routes', this._code)
        //   .then(function() {
        //     return self.$.routeDetails.save('/route-details', self._code);
        //   }).then(function() {
        //     self._showOperationResultModal(true);
        //   }).catch(function(error) {
        //     self._showOperationResultModal(false, error);
        //     console.log(error);
        //   });
      },

      _showOperationResultModal: function(isSuccess, operationDetailMessage) {
        var self = this;
        this._operationSuccess = isSuccess;
        this.$.saveOperationResultModal.open();
        this._operationMessageDetail = operationDetailMessage;

        setTimeout(function() {
          self.$.saveOperationResultModal.close();
        }, 2500)
      },

      _getStopObj: function(baseStop) {
        var newStopObj = {
          name: baseStop.name,
          lat: baseStop.lat,
          lng: baseStop.lng,
          route_list: baseStop.route_list,
        };

        return newStopObj;
      },

      _jsonHasKeys: function(json) {
        if (json) {
          for (var key in json) {
            return true;
          }
        }

        return false;
      },

      _openDeleteRouteModal : function(){
        this.$.deleteRouteModal.open();
      },

      _deleteRoute : function(){
        var self = this;
        this._routeInfo = null;
        this._routeDetails = null;
        this._routeInfoOrigin = this._routeInfo;
        this._routeDetailsOrigin = this._routeDetails;

        // Delete the route using document save method
        this.$.routeInfo.save('/routes', this._code)
          .then(function() {
            return self.$.routeDetails.save('/route-details', self._code);
          }).then(function() {
            page('/routes');
          }).catch(function(error) {
            self._showOperationResultModal(false, error);
            console.log(error);
          });
      }
    });
  })();
  </script>
</dom-module>
