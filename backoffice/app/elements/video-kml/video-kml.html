<dom-module id="video-kml">
  <template>
    <style is="custom-style" include="shared-styles"></style>
    <style>
      .item-wrapper,
      .header {
        border-bottom: 1px solid #ccc;
      }
      hr {

        border-color: var(--primary-color);
      }

      .item-wrapper:hover {
        background-color: var(--vta-light-gray);
      }

      .item-wrapper.active:hover {
        background-color: var(--vta-white);
      }

      .item {
        padding: 12px 5% 0;
        @apply(--layout-horizontal);
        font-size: 1.05em;
        color: var(--secondary-text-color);
      }

      .item-wrapper.active .item {
        color: var(--primary-color);
      }

      .header {
        padding: 20px 5% 18px;
        color: var(--primary-color);
        font-weight: bold;
        font-size: 1.4em;
      }

      .route-code,.stop-code {
        min-width: 10%;
        padding: 0 20px;
        font-weight: bold;
      }

      .item-wrapper.active .route-name,.item-wrapper.active .stop-name {
        margin-bottom: 20px;
      }

      .route-details,.stop-details {
        @apply(--layout-flex);
      }

      .route-operations,.stop-operations {
        padding: 0 20px;
        margin-top: -12px;
      }

      paper-fab {
        position: absolute;
        right: 8%;
        top: -28px;
      }

      paper-button {
        top: 2px;
        padding: 0;
        background-color: transparent;
        color: var(--secondary-text-color);
      }

      paper-button iron-icon {
        --iron-icon-height: 40px;
        --iron-icon-width: 40px;
      }

      .route-departure-destination, .stop-departure-destination,.stop-list-listing {
        margin-bottom: 20px;
        display: none;
        color: var(--secondary-text-color);
      }

      .item-wrapper.active .route-departure-destination, .item-wrapper.active .stop-departure-destination, .item-wrapper.active .stop-list-listing {
        @apply(--layout-horizontal);
      }

      .route-departure,
      .route-destination,.stop-lat,
      .stop-lng {
        @apply(--layout-flex);
        @apply(--layout-horizontal);
      }

      .route-detail-header,.stop-lat-header {
        font-weight: bold;
        margin-right: 30px;
      }

      .edit-route-operation,.stop-route-operation {
        display: none;
        padding: 21px 5%;
        font-size: 1.4em;
        text-transform: capitalize;
        text-align: right;
      }

      .item-wrapper.active paper-button iron-icon.expand,
      .item-wrapper paper-button iron-icon.collapse,
      .route-map-template,
      .stop-map-template,
      .item-wrapper route-map {
        display: none;
      }

      .item-wrapper paper-button iron-icon.expand,
      .item-wrapper.active paper-button iron-icon.collapse,
      .item-wrapper.active route-map,
      .item-wrapper.active .edit-route-operation {
        display: block;
      }
      #byte_content {
        margin: 5px 0;
        max-height: 100px;
        overflow-y: auto;
        overflow-x: hidden;
      }
      #byte_range { margin-top: 5px; }
      .loadButtons{
            width: 12%;
            background: gainsboro;
      }
      .add-stop-wrapper {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        float: left;
      }

      .add-stop-wrapper paper-button {
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        padding: 0.2em .6em;
        width: 253px;

      }
      .clear-break{
        clear:both;
      }

      paper-toolbar {
        --paper-toolbar-background: var(--paper-blue-900);
      }
      paper-button.primary {
        color: var(--primary-color);
        font-size: 22px;
      }
      .column1 {
        width: 50%;
        padding: 0 2px 0 0;
        margin-right: 0%;
      }

      .column-container {
        width: 35%;
      }
      .stop-list-listing{
        margin-left: 0px;
        padding-left: 0px;
        width: 100%;
      }
      .download-icon{
        height: 20px;
      }

      #saveOperationResultModal {
        width: auto;
        background-color: transparent;
        color: var(--vta-white);
        box-shadow: none;
      }

      #saveOperationResultModal .icon {
        text-align: center;
      }

      #saveOperationResultModal iron-icon {
        width: 140px;
        height: 140px;
        padding: 20px;
        text-align: center;
        -webkit-border-radius: 50%;
        border-radius: 50%;
      }

      #saveOperationResultModal .message-wrapper.success iron-icon {
        background-color: var(--primary-color);
      }

      #saveOperationResultModal .message-wrapper.error iron-icon {
        background-color: var(--secondary-color);
      }

      #saveOperationResultModal .message {
        text-align: center;
        font-size: 2.5em;
        line-height: 1;
        text-transform: uppercase;
        font-weight: bold;
        margin-top: 10px;
      }

      #mis_matched_routes{
        margin-top: 5%;
        word-wrap: break-word;
        display: none;
      }

      .video-wrapper{
        width: 50%;
        word-wrap: break-word;
      }
    </style>

    <firebase-document
      app-name="vta"
      id="routeInfo"
      data="{{_routeInfoOrigin}}">
    </firebase-document>
    <firebase-document
      app-name="vta"
      id="routeDetails"
      data="{{_routeDetailsOrigin}}">
    </firebase-document>
    <firebase-document
      app-name="vta"
      id="routeDataProcessing">
    </firebase-document>
    <div class="inner-content">
      <h2 class="page-title">Video</h2>

      <div>
        <br/>
      &nbsp;Step 1: Click on "Video Generation" to generate route video and KML data :
      <br/>
        <div class="add-stop-wrapper">
        <a href="[[_video_generation_server_url]]" target="_blank">
          <paper-button  >
          <iron-icon icon="file-download" class="download-icon"></iron-icon>Video Generation
        </paper-button>
      </a>
       </div>
      </div>
      <div>
        <br/><br/><br/>
      &nbsp;Step 2: Click on "Preview Route List" to preview latest route video and KML data:
      <br/>
        <template is="dom-if" if="[[!_imported_routes.length]]">
          <div class="add-stop-wrapper">
          <paper-button on-click="_startVideoUrlsAndStartKmlPrepareDataAndStartProcessing" >
            <iron-icon icon="file-download" class="download-icon"></iron-icon>Preview Route List
          </paper-button>
         </div>
        </template>

        <template is="dom-if" if="[[_imported_routes.length]]">
          <div class="add-stop-wrapper">
          <paper-button disabled >
            <iron-icon icon="file-download" class="download-icon"></iron-icon>Preview Route List
          </paper-button>
         </div>
         <div class="add-stop-wrapper">
         <paper-button onclick="if(confirm('Are you sure? this will reset the list and you will have to generate the list again')){location.reload();}" >
           <iron-icon icon="icons:autorenew" class="download-icon"></iron-icon>Reset Route List Preview
         </paper-button>
        </div>
        </template>

        <input type="checkbox" id="generated_video_only"> Only recently generated videos


      </div>
      <br/><br/>
      <div>
        &nbsp;WARNING: Use with caution. Updating URLs and KMLs for all videos have risk of  impacting website performance and may cause downtime.
      </div>
      <div class="clear-break">
        <div class="add-stop-wrapper">

       </div>
      </div>
      <br/>
      &nbsp;Step 3: Click on "Batch Update" to update data in firebase database:
      <br/>
      <div class="clear-break">
        <div class="add-stop-wrapper">
        <paper-button  on-click="_batchImportRoutesListData" ><iron-icon icon="file-download" class="download-icon"></iron-icon>Batch Update</paper-button>
          </div>
      </div>
      <div>
      </div>

      <div id="mis_matched_routes"> </div>

      <br/>
      <br/>
      <paper-material elevation="1">
        <paper-tabs scrollable selected="0" fit-container>
          <paper-tab>Routes</paper-tab>
        </paper-tabs>
        <template is="dom-if" if="[[_routesTabIsSelected(selectedTab)]]">
          <div class="item header">
            <div class="route-code">Code</div>
            <div class="route-details">Route name</div>
            <div class="route-operations">

            </div>
          </div>
          <template is="dom-repeat" items="[[_imported_routes]]" as="route">
            <div class="item-wrapper" data-route-index$="[[index]]" data-route-code$="[[route.code]]">
              <div class="item route">
                <div class="route-code">[[route.code]]</div>
                <div class="route-details">
                  <div class="route-name">[[route.name]]</div>
                  <div class="route-departure-destination">
                    <div class="route-departure">
                      <div class="route-detail-header">Departure</div>
                      <div class="route-detail-value">[[route.departure]]</div>
                    </div>
                    <div class="route-destination">
                      <div class="route-detail-header">Destination</div>
                      <div class="route-detail-value">[[route.destination]]</div>
                    </div>
                    <!-- <div class="route-departure">
                      <div class="route-detail-header">Latitude</div>
                      <div class="route-detail-value">[[route.latitude]]</div>
                    </div>
                    <div class="route-departure">
                      <div class="route-detail-header">Longitude</div>
                      <div class="route-detail-value">[[route.longitude]]</div>
                    </div> -->
                  </div>
                  <div class="container item stop-list-listing">
                    <div class="column1">
                      <div class="video-wrapper">
                          <h3>Direction A - Videos</h3>
                            <div>
                              <span>Front Video(High Resolution): <br/></span> <a target="_blank" href="[[route.routeDetails.a.videoUrl]]"><span>[[route.routeDetails.a.videoUrl]]</span></a><br/>
                              <span>KML Url Front(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.a.KmlUrl]]"><span>[[route.routeDetails.a.KmlUrl]]</span></a><hr/>
                              <span>Front Video(Low Resolution): <br/></span> <a target="_blank" href="[[route.routeDetails.a.videoUrlLowRes]]"><span>[[route.routeDetails.a.videoUrlLowRes]]</span></a><br/>
                              <span>KML Url Front(for Low Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.a.KmlUrlLowRes]]"><span>[[route.routeDetails.a.KmlUrlLowRes]]</span></a>
                            </div>
                            <hr/>
                            <div>
                              <span>Back Video(High Resolution): </span><br/> <a target="_blank" href="[[route.routeDetails.a.videoBackUrl]]"><span>[[route.routeDetails.a.videoBackUrl]]</span></a><br/>
                              <span>KML Url Back(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.a.KmlUrlBack]]"><span>[[route.routeDetails.a.KmlUrlBack]]</span></a><hr/>
                              <span>Back Video(Low Resolution): <br/></span> <a target="_blank" href="[[route.routeDetails.a.videoBackUrlLowRes]]"><span>[[route.routeDetails.a.videoBackUrlLowRes]]</span></a><br/>
                              <span>KML Url Back(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.a.KmlUrlBackLowRes]]"><span>[[route.routeDetails.a.KmlUrlBackLowRes]]</span></a>
                            </div>
                            <hr/>
                            <div>
                              <span>Left Video(High Resolution):</span> <br/><a target="_blank" href="[[route.routeDetails.a.videoLeftUrl]]"><span>[[route.routeDetails.a.videoLeftUrl]]</span></a><br/>
                              <span>KML Url Left(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.a.KmlUrlLeft]]"><span>[[route.routeDetails.a.KmlUrlLeft]]</span></a><hr/>
                              <span>Left Video(Low Resolution): <br/></span> <a target="_blank" href="[[route.routeDetails.a.videoLeftUrlLowRes]]"><span>[[route.routeDetails.a.videoLeftUrlLowRes]]</span></a><br/>
                              <span>KML Url Left(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.a.KmlUrlLeftLowRes]]"><span>[[route.routeDetails.a.KmlUrlLeftLowRes]]</span></a>
                            </div>
                            <hr/>
                            <div>
                              <span>Right Video(High Resolution):</span><br/> <a target="_blank" href="[[route.routeDetails.a.videoRightUrl]]"><span>[[route.routeDetails.a.videoRightUrl]]</span></a><br/>
                                <span>KML Url Right(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.a.KmlUrlRight]]"><span>[[route.routeDetails.a.KmlUrlRight]]</span></a><hr/>
                              <span>Right Video (Low Resolution): </span><br/> <a target="_blank" href="[[route.routeDetails.a.videoRightUrlLowRes]]"><span>[[route.routeDetails.a.videoRightUrlLowRes]]</span></a><br/>
                                <span>KML Url Right(For Low Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.a.KmlUrlRightLowRes]]"><span>[[route.routeDetails.a.KmlUrlRightLowRes]]</span></a>
                            </div>

                      </div>
                        <!-- <div class="stops-wrapper">
                          <h3>Direction A - Stops</h3>
                          <div class="stop-list">
                            <div role="listbox">
                              <template is="dom-repeat" items="{{route.routeDetails.a.stops}}" as="stop">
                                <paper-item>
                                  <paper-item-body>[[stop.name]]
                                      <template is="dom-if" if="{{stop.sec}}">
                                        <br/>
                                        (Second : [[stop.sec]])
                                      </template>
                                </paper-item-body>
                                </paper-item>
                                </template>
                                </div>
                                </div>
                                </div> -->
  </div>
  <div class="column1">
    <div class="video-wrapper">
      <h3>Direction B - Videos</h3>
      <div>
        <span>Front Video(High Resolution): <br/></span> <a target="_blank" href="[[route.routeDetails.b.videoUrl]]"><span>[[route.routeDetails.b.videoUrl]]</span></a><br/>
        <span>KML Url Front(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.b.KmlUrl]]"><span>[[route.routeDetails.b.KmlUrl]]</span></a>
        <hr/>
        <span>Front Video(Low Resolution): <br/></span> <a target="_blank" href="[[route.routeDetails.b.videoUrlLowRes]]"><span>[[route.routeDetails.b.videoUrlLowRes]]</span></a><br/>
        <span>KML Url Front(for Low Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.b.KmlUrlLowRes]]"><span>[[route.routeDetails.b.KmlUrlLowRes]]</span></a>
      </div>
      <hr/>
      <div>
        <span>Back Video: </span><br/> <a target="_blank" href="[[route.routeDetails.b.videoBackUrl]]"><span>[[route.routeDetails.b.videoBackUrl]]</span></a><br/>
        <span>KML Url Back(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.b.KmlUrlBack]]"><span>[[route.routeDetails.b.KmlUrlBack]]</span></a>
        <hr/>
        <span>Back Video(Low Resolution): <br/></span> <a target="_blank" href="[[route.routeDetails.b.videoBackUrlLowRes]]"><span>[[route.routeDetails.b.videoBackUrlLowRes]]</span></a><br/>
        <span>KML Url Back(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.b.KmlUrlBackLowRes]]"><span>[[route.routeDetails.b.KmlUrlBackLowRes]]</span></a>
      </div>
      <hr/>
      <div>
        <span>Left Video: </span> <br/><a target="_blank" href="[[route.routeDetails.b.videoLeftUrl]]"><span>[[route.routeDetails.b.videoLeftUrl]]</span></a><br/>
        <span>KML Url Left(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.b.KmlUrlLeft]]"><span>[[route.routeDetails.b.KmlUrlLeft]]</span></a>
        <hr/>
        <span>Left Video(Low Resolution): <br/></span> <a target="_blank" href="[[route.routeDetails.b.videoLeftUrlLowRes]]"><span>[[route.routeDetails.b.videoLeftUrlLowRes]]</span></a><br/>
        <span>KML Url Left(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.b.KmlUrlLeftLowRes]]"><span>[[route.routeDetails.b.KmlUrlLeftLowRes]]</span></a>

      </div>
      <hr/>
      <div>
        <span>Right Video(High Resolution): </span><br/> <a target="_blank" href="[[route.routeDetails.b.videoRightUrl]]"><span>[[route.routeDetails.b.videoRightUrl]]</span></a><br/>
        <span>KML Url Right(For High Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.b.KmlUrlRight]]"><span>[[route.routeDetails.b.KmlUrlRight]]</span></a>
        <hr/>
        <span>Right Video (Low Resolution): </span><br/> <a target="_blank" href="[[route.routeDetails.b.videoRightUrlLowRes]]"><span>[[route.routeDetails.b.videoRightUrlLowRes]]</span></a><br/>
        <span>KML Url Right(For Low Resolution): </span> <br/><a target="_blank" href="[[route.routeDetails.b.KmlUrlRightLowRes]]"><span>[[route.routeDetails.b.KmlUrlRightLowRes]]</span></a>

      </div>
      <hr/>

    </div>
    <!-- <div class="stops-wrapper">
      <h3>Direction B - Stops</h3>
      <div class="stop-list">
        <div role="listbox">
          <template is="dom-repeat" items="{{route.routeDetails.b.stops}}" as="stop">
                                <paper-item>
                                  <paper-item-body>[[stop.name]]

                                    <template is="dom-if" if="{{stop.sec}}">
                                        <br/>
                                      (Second : [[stop.sec]])
                                    </template>
          </paper-item-body>
          </paper-item>
          </template>
        </div>
      </div>
    </div> -->
  </div>
  </div>
  </div>
  <div class="route-operations">
    <paper-button on-click="_toggleRoute" data-route-index$="[[index]]">
      <iron-icon class="expand" icon="icons:expand-more"></iron-icon>
      <iron-icon class="collapse" icon="icons:expand-less"></iron-icon>
    </paper-button>
  </div>
  </div>
  <div class="route-map" style="display:none;"></div>
  </div>
  </template>

  <div class="route-map-template">
    <route-map id="routeMap" geo-points="{{_videoGeoPointsOrigin}}"></route-map>
  </div>
  </template>
  </paper-material>
  </div>
  <paper-dialog id="saveOperationResultModal" modal>
    <template is="dom-if" if="{{_operationSuccess}}">
        <div class="message-wrapper success">
          <div class="icon">
            <iron-icon icon="icons:check"></iron-icon>
          </div>
          <div class="message">Done</div>
          <div class="">{{_operationMessageDetail}}</div>
        </div>
      </template>
    <template is="dom-if" if="{{!_operationSuccess}}">
        <div class="message-wrapper success">
          <div class="icon">
            <iron-icon icon="icons:cached"></iron-icon>
          </div>
          <div class="message">Processing...</div>
          <div class="">{{_operationMessageDetail}}</div>
        </div>
      </template>
  </paper-dialog>
  <maps-utils id="mapsUtils"></maps-utils>
  <kml-parser id="tempKmlParser"></kml-parser>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'video-kml',

        properties: {
          _imported_routes: {
            type: Array,
            value: []
          },
          _imported_stops: {
            type: Array,
            value: []
          },
          _mismatchedRoutes:{
            type: Array,
            value: []
          },
          _activeStopCode: {
            type: String,
            value: ''
          },
          _video_generation_server_url:{
            type: String,
            value: ''
          },
          _routes: {
            type: Array
          },
          _activeRouteCode: {
            type: String,
            value: ''
          },
          selectedTab: {
            type: Number,
            value: 0
          },
          _videoGeoPointsOrigin: {
            type: Object,
            value: {}
          },
          _routeInfoOrigin: {
            type: Object,
            //observer: '_routeInfoOriginChange'
          },
          _settings: {
            type: Object,
            value: {}
          },
          _routeInfo: {
            type: Object,
            value: {}
          },
          _routeDetailsOrigin: {
            type: Object,
            //observer: '_routeDetailsOriginChange'
          },
          _routeDetails: {
            type: Object,
            value: {
              a: {
                stops: [],
                videoGeoPoints: {},
                videoUrl: ""
              },
              b: {
                stops: [],
                videoGeoPoints: {},
                videoUrl: ""
              }
            }
          },
        },
        _showOperationResultModal: function(isSuccess, operationDetailMessage) {
          this.$.saveOperationResultModal.open();
          var self = this;
          this._operationSuccess = isSuccess;
          this._operationMessageDetail = operationDetailMessage;
        },
        _closeOperationResultModal: function() {
          this.$.saveOperationResultModal.close();
        },
        _stopTabIsSelected: function(selectedTB) {
          return selectedTB === 0;
        },
        _routesTabIsSelected: function(selectedTB) {
          return selectedTB === 1;
        },
        _setStops: function(stopListArray) {
          this._imported_stops = stopListArray;
          this.selectedTab = 0;
          this.$.saveOperationResultModal.close();
          this._showOperationResultModal(true, "Stop list data loaded, after all stops data loaded you can load route list data");
          var self = this;
          setTimeout(function() {
            self.$.saveOperationResultModal.close();
          }, 1000);
        },
        _setKmlFiles: function(routeListArray, callback) {
          console.log('Going to start Processing KML file');
          var self = this;
          var baseUrl = "";
          if(this._settings){
            if(this._settings.video_server_url){
              baseUrl = this._settings.video_server_url;
            }
            if(this._settings.s3_bucket_name){
              baseUrl = baseUrl +'/'+this._settings.s3_bucket_name + '/';
            }
            if(this._settings.environment){
              baseUrl = baseUrl.slice(0,-1);
              baseUrl = baseUrl+'/'+this._settings.environment+'/';
            }
          }
          var processKmlUrl = function(url, cb) {
            if (!url) {
              return cb(null);
            }
            console.log('Trying KML url: ' + url);
            // console.log("processing: "+url);
            // var settings = {
            //     "async": true,
            //     "crossDomain": true,
            //     "url": "http://localhost:5001/kml_file/10_a.kml",
            //     "method": "GET",
            //   }
            //
            //   $.ajax(settings).done(function (response) {
            //     console.log(response);
            //     if(response.status==200){
            //       self.$.tempKmlParser.parseFromText(response.responseText,cb);
            //     }else{
            //       cb(null);
            //     }
            //   });
            var data = null;

            var xhr = new XMLHttpRequest();
            xhr.withCredentials = false;

            xhr.addEventListener("readystatechange", function() {
              console.log(this.readyState);
              if (this.readyState === 4) {
                console.log('check response');
                console.log(this.responseText);
                //console.log(this)
                if (this.status == 200) {
                  self.$.tempKmlParser.parseFromText(this.responseText, cb);
                } else {
                  cb(null);
                }
              }
            });

            xhr.open("GET", url);
            //xhr.setRequestHeader("cache-control", "no-cache");
            //xhr.setRequestHeader("postman-token", "861478f2-6ea2-0a27-a144-1475782148d3");

            xhr.send(data);
          }

          var processRoute = function(index) {
            console.log('Processing: ' + index);
            console.log('Processing Total KMLS: ' + routeListArray.length);
            if (index < routeListArray.length) {
              var fullRouteDetails = routeListArray[index];
              var directionAKmlUrl = "";
              var directionALeftViewKmlUrl = "";
              var directionARightViewKmlUrl = "";
              var directionABackViewKmlUrl = "";

              var directionAKmlUrlLowRes = "";
              var directionALeftViewKmlUrlLowRes = "";
              var directionARightViewKmlUrlLowRes = "";
              var directionABackViewKmlUrlLowRes = "";

              var directionBKmlUrl = "";
              var directionBLeftViewKmlUrl = "";
              var directionBRightViewKmlUrl = "";
              var directionBBackViewKmlUrl = "";

              var directionBKmlUrlLowRes = "";
              var directionBLeftViewKmlUrlLowRes = "";
              var directionBRightViewKmlUrlLowRes = "";
              var directionBBackViewKmlUrlLowRes = "";

              var code = fullRouteDetails.code;
              var isDefaultKmlfileA = false;
              var isDefaultKmlfileB = false;
              var mismatch = false;
              var mismatchableA = false;
              var mismatchableB = false;

              if (fullRouteDetails.routeDetailsResources && fullRouteDetails.routeDetailsResources.latestResources) {
                if (fullRouteDetails.routeDetailsResources.latestResources.a) {
                  mismatchableA = true;
                  if (fullRouteDetails.routeDetailsResources.latestResources.a.KmlUrl) {
                    directionAKmlUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.a.KmlUrl;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResources.a.KmlUrlLeft) {
                    directionALeftViewKmlUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.a.KmlUrlLeft;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResources.a.KmlUrlRight) {
                    directionARightViewKmlUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.a.KmlUrlRight;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResources.a.KmlUrlBack) {
                    directionABackViewKmlUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.a.KmlUrlBack;
                  }
                }
                if (fullRouteDetails.routeDetailsResources.latestResources.b) {
                    mismatchableB = true;
                  if (fullRouteDetails.routeDetailsResources.latestResources.b.KmlUrl) {
                    directionBKmlUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.b.KmlUrl;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResources.b.KmlUrlLeft) {
                    directionBLeftViewKmlUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.b.KmlUrlLeft;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResources.b.KmlUrlRight) {
                    directionBRightViewKmlUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.b.KmlUrlRight;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResources.b.KmlUrlBack) {
                    directionBBackViewKmlUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.b.KmlUrlBack;
                  }
                }
              }

              if (fullRouteDetails.routeDetailsResources && fullRouteDetails.routeDetailsResources.latestResourcesLowResolution) {
                if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a) {
                  if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.KmlUrl) {
                    directionAKmlUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.KmlUrl;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.KmlUrlLeft) {
                    directionALeftViewKmlUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.KmlUrlLeft;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.KmlUrlRight) {
                    directionARightViewKmlUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.KmlUrlRight;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.KmlUrlBack) {
                    directionABackViewKmlUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.KmlUrlBack;
                  }
                }
                if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b) {
                  if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.KmlUrl) {
                    directionBKmlUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.KmlUrl;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.KmlUrlLeft) {
                    directionBLeftViewKmlUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.KmlUrlLeft;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.KmlUrlRight) {
                    directionBRightViewKmlUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.KmlUrlRight;
                  }
                  if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.KmlUrlBack) {
                    directionBBackViewKmlUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.KmlUrlBack;
                  }
                }
              }

              processKmlUrl(directionAKmlUrl, function(parsedAData) {
                console.log('check parsed data');
                console.log(parsedAData);
                fullRouteDetails.routeDetails.a.KmlUrl = directionAKmlUrl;
                if (parsedAData) {
                  fullRouteDetails.routeDetails.a.videoGeoPoints = parsedAData;
                }else{
                  fullRouteDetails.routeDetails.a.videoUrl = "";
                  if(mismatchableA && directionAKmlUrl){
                      mismatch = true;
                  }

                }
                processKmlUrl(directionBKmlUrl, function(parsedBData) {
                  fullRouteDetails.routeDetails.b.KmlUrl = directionBKmlUrl;
                  if (parsedBData) {
                    fullRouteDetails.routeDetails.b.videoGeoPoints = parsedBData;
                  }else{
                    fullRouteDetails.routeDetails.b.videoUrl = "";
                    if(mismatchableB && directionBKmlUrl){
                        mismatch = true;
                    }
                  }
                  processKmlUrl(directionALeftViewKmlUrl, function(parsedALeftViewKmlUrl) {
                    fullRouteDetails.routeDetails.a.KmlUrlLeft = directionALeftViewKmlUrl;
                    if (parsedALeftViewKmlUrl) {
                      fullRouteDetails.routeDetails.a.videoGeoPointsLeft = parsedALeftViewKmlUrl;
                    }else{
                    fullRouteDetails.routeDetails.a.videoLeftUrl = "";
                    if(mismatchableA && directionALeftViewKmlUrl){
                        mismatch = true;
                    }
                    }
                    processKmlUrl(directionARightViewKmlUrl, function(parsedARightViewKmlUrl) {
                      fullRouteDetails.routeDetails.a.KmlUrlRight = directionARightViewKmlUrl;
                      if (parsedARightViewKmlUrl) {
                        fullRouteDetails.routeDetails.a.videoGeoPointsRight = parsedARightViewKmlUrl;
                      }else{
                        fullRouteDetails.routeDetails.a.videoRightUrl = "";
                        if(mismatchableA && directionARightViewKmlUrl){
                            mismatch = true;
                        }
                      }
                      processKmlUrl(directionABackViewKmlUrl, function(parsedABackViewKmlUrl) {
                        fullRouteDetails.routeDetails.a.KmlUrlBack = directionABackViewKmlUrl;
                        if (parsedABackViewKmlUrl) {
                          fullRouteDetails.routeDetails.a.videoGeoPointsBack = parsedABackViewKmlUrl;
                        }else{
                          fullRouteDetails.routeDetails.a.videoBackUrl = "";
                          if(mismatchableA && directionABackViewKmlUrl){
                              mismatch = true;
                          }
                        }

                        processKmlUrl(directionBLeftViewKmlUrl, function(parsedBLeftViewKmlUrl) {
                          fullRouteDetails.routeDetails.b.KmlUrlLeft = directionABackViewKmlUrl;
                          if (parsedBLeftViewKmlUrl) {
                            fullRouteDetails.routeDetails.b.videoGeoPointsLeft = parsedBLeftViewKmlUrl;
                          }else{
                            fullRouteDetails.routeDetails.b.videoLeftUrl = "";
                            if(mismatchableB && directionBLeftViewKmlUrl){
                                mismatch = true;
                            }
                          }
                          processKmlUrl(directionBRightViewKmlUrl, function(parsedBRightViewKmlUrl) {
                            fullRouteDetails.routeDetails.b.KmlUrlRight = directionBRightViewKmlUrl;
                            if (parsedBRightViewKmlUrl) {
                              fullRouteDetails.routeDetails.b.videoGeoPointsRight = parsedBRightViewKmlUrl;
                            }else{
                              fullRouteDetails.routeDetails.b.videoRightUrl = "";
                              if(mismatchableB && directionBRightViewKmlUrl){
                                  mismatch = true;
                              }
                            }
                            processKmlUrl(directionBBackViewKmlUrl, function(parsedBBackViewKmlUrl) {
                              fullRouteDetails.routeDetails.b.KmlUrlBack = directionBBackViewKmlUrl;
                              if (parsedBBackViewKmlUrl) {
                                fullRouteDetails.routeDetails.b.videoGeoPointsBack = parsedBBackViewKmlUrl;
                              }else{
                                fullRouteDetails.routeDetails.b.videoBackUrl = "";
                                if(mismatchableB && directionBBackViewKmlUrl){
                                    mismatch = true;
                                }
                              }
                              processKmlUrl(directionAKmlUrlLowRes, function(parsedADataLowRes) {
                                fullRouteDetails.routeDetails.a.KmlUrlLowRes = directionAKmlUrlLowRes;
                                if (parsedADataLowRes) {
                                  fullRouteDetails.routeDetails.a.videoGeoPointsLowRes = parsedADataLowRes;
                                }else{
                                  fullRouteDetails.routeDetails.a.videoUrlLowRes = "";
                                  if(mismatchableA && directionAKmlUrlLowRes){
                                      mismatch = true;
                                  }
                                }
                                processKmlUrl(directionBKmlUrlLowRes, function(parsedBDataLowRes) {
                                  fullRouteDetails.routeDetails.b.KmlUrlLowRes = directionBKmlUrlLowRes;
                                  if (parsedBDataLowRes) {
                                    fullRouteDetails.routeDetails.b.videoGeoPointsLowRes = parsedBDataLowRes;
                                  }else{
                                      fullRouteDetails.routeDetails.b.videoUrlLowRes = "";
                                      if(mismatchableB && directionBKmlUrlLowRes){
                                          mismatch = true;
                                      }
                                  }
                                  processKmlUrl(directionALeftViewKmlUrlLowRes, function(parsedALeftViewKmlUrlLowRes) {
                                    fullRouteDetails.routeDetails.a.KmlUrlLeftLowRes = directionALeftViewKmlUrlLowRes;
                                    if (parsedALeftViewKmlUrlLowRes) {
                                      fullRouteDetails.routeDetails.a.videoGeoPointsLeftLowRes = parsedALeftViewKmlUrlLowRes;
                                    }else{
                                        fullRouteDetails.routeDetails.a.videoLeftUrlLowRes = "";
                                        if(mismatchableA && directionALeftViewKmlUrlLowRes){
                                            mismatch = true;
                                        }
                                    }
                                    processKmlUrl(directionARightViewKmlUrlLowRes, function(parsedARightViewKmlUrlLowRes) {
                                      fullRouteDetails.routeDetails.a.KmlUrlRightLowRes = directionARightViewKmlUrlLowRes;
                                      if (parsedARightViewKmlUrlLowRes) {
                                        fullRouteDetails.routeDetails.a.videoGeoPointsRightLowRes = parsedARightViewKmlUrlLowRes;
                                      }else{
                                          fullRouteDetails.routeDetails.a.videoRightUrlLowRes = "";
                                          if(mismatchableA && directionARightViewKmlUrlLowRes){
                                              mismatch = true;
                                          }
                                      }
                                      processKmlUrl(directionABackViewKmlUrlLowRes, function(parsedABackViewKmlUrlLowRes) {
                                        fullRouteDetails.routeDetails.a.KmlUrlBackLowRes = directionABackViewKmlUrlLowRes;
                                        if (parsedABackViewKmlUrlLowRes) {
                                          fullRouteDetails.routeDetails.a.videoGeoPointsBackLowRes = parsedABackViewKmlUrlLowRes;
                                        }else{
                                          fullRouteDetails.routeDetails.a.videoBackUrlLowRes = "";
                                          if(mismatchableA && directionABackViewKmlUrlLowRes){
                                              mismatch = true;
                                          }
                                        }

                                        processKmlUrl(directionBLeftViewKmlUrlLowRes, function(parsedBLeftViewKmlUrlLowRes) {
                                          fullRouteDetails.routeDetails.b.KmlUrlLeftLowRes = directionBLeftViewKmlUrlLowRes;
                                          if (parsedBLeftViewKmlUrlLowRes) {
                                            fullRouteDetails.routeDetails.b.videoGeoPointsLeftLowRes = parsedBLeftViewKmlUrlLowRes;
                                          }else{
                                              fullRouteDetails.routeDetails.b.videoLeftUrlLowRes = "";
                                              if(mismatchableB && directionBLeftViewKmlUrlLowRes){
                                                  mismatch = true;
                                              }
                                          }
                                          processKmlUrl(directionBRightViewKmlUrlLowRes, function(parsedBRightViewKmlUrlLowRes) {
                                            fullRouteDetails.routeDetails.b.KmlUrlRightLowRes = directionBRightViewKmlUrlLowRes;
                                            if (parsedBRightViewKmlUrlLowRes) {
                                              fullRouteDetails.routeDetails.b.videoGeoPointsRightLowRes = parsedBRightViewKmlUrlLowRes;
                                            }else{
                                                fullRouteDetails.routeDetails.b.videoRightUrlLowRes = "";
                                                if(mismatchableB && directionBRightViewKmlUrlLowRes){
                                                    mismatch = true;
                                                }
                                            }
                                            processKmlUrl(directionBBackViewKmlUrlLowRes, function(parsedBBackViewKmlUrlLowRes) {
                                              fullRouteDetails.routeDetails.b.KmlUrlBackLowRes = directionBBackViewKmlUrlLowRes;
                                              if (parsedBBackViewKmlUrlLowRes) {
                                                fullRouteDetails.routeDetails.b.videoGeoPointsBackLowRes = parsedBBackViewKmlUrlLowRes;
                                              }else{
                                                fullRouteDetails.routeDetails.b.videoBackUrlLowRes = "";
                                                if(mismatchableB && directionBBackViewKmlUrlLowRes){
                                                    mismatch = true;
                                                }
                                              }
                                              fullRouteDetails.mismatch = mismatch;
                                              if(fullRouteDetails.mismatch){
                                                if(!self._mismatchedRoutes){
                                                  self._mismatchedRoutes = [];
                                                }
                                                self._mismatchedRoutes.push(fullRouteDetails.code);
                                              }
                                              routeListArray[index] = fullRouteDetails;
                                              processRoute(index + 1);

                                            });

                                          })

                                        })
                                      });

                                    });


                                  });
                                });
                              });

                            })

                          })

                        })
                      });

                    });


                  });
                });
              });

            } else {
              callback(routeListArray)
            }
          }
          //callback(routeListArray)
          processRoute(0);


        },
        _videoLinkBindingExistenceCheck: function(routeListArray, callback) {
          var self = this;
          var baseUrl = "";
          if(this._settings){
            if(this._settings.video_server_url){
              baseUrl = this._settings.video_server_url;
            }
            if(this._settings.s3_bucket_name){
              baseUrl = baseUrl +'/'+this._settings.s3_bucket_name + '/';
            }
            if(this._settings.environment){
              baseUrl = baseUrl.slice(0,-1);
              baseUrl = baseUrl+'/'+this._settings.environment+'/';
            }
          }
          console.log('base Url: '+baseUrl);
          console.log(routeListArray);
          var processVideoUrl = function(url, cb) {
            if (!url) {
              return cb(false);
            }

            var data = null;
            var xhr = new XMLHttpRequest();
            xhr.withCredentials = false;
            xhr.addEventListener("readystatechange", function() {
              console.log(this.readyState);
              if (this.readyState === 4) {
                console.log('check response');
                console.log(this.responseText);
                //console.log(this)
                if (this.status == 200) {
                  cb(true);
                } else {
                  cb(false);
                }
              }
            });
            xhr.open("HEAD", url);
            //xhr.setRequestHeader("cache-control", "no-cache");
            //xhr.setRequestHeader("postman-token", "861478f2-6ea2-0a27-a144-1475782148d3");
            xhr.send(data);
          }
          var processRoute = function(index) {
            console.log('Processing: ' + index);
            console.log('Toral Routes: '+ routeListArray.length);
            if (index < routeListArray.length) {
              console.log('Entering Loop');
              var fullRouteDetails = routeListArray[index];
              var videoCode = fullRouteDetails.code;
              var videoAUrl = "";
              var videoALeftUrl = "";
              var videoARightUrl = "";
              var videoABackUrl = "";
              var videoBUrl = "";
              var videoBLeftUrl = "";
              var videoBRightUrl = "";
              var videoBBackUrl = "";
              var videoAUrlLowRes = "";
              var videoALeftUrlLowRes = "";
              var videoARightUrlLowRes = "";
              var videoABackUrlLowRes = "";
              var videoBUrlLowRes = "";
              var videoBLeftUrlLowRes = "";
              var videoBRightUrlLowRes = "";
              var videoBBackUrlLowRes = "";
              var isLatestSerourceA = false;
              var isLatestSerourceB = false;



                console.log('Parsing stage 1');

              if (fullRouteDetails.routeDetailsResources && fullRouteDetails.routeDetailsResources.latestResources) {
                if (fullRouteDetails.routeDetailsResources.latestResources.a) {
                  videoAUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.a.videoUrl;
                  videoALeftUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.a.videoLeftUrl;
                  videoARightUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.a.videoRightUrl;
                  videoABackUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.a.videoBackUrl;
                }
                if (fullRouteDetails.routeDetailsResources.latestResources.b) {
                  videoBUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.b.videoUrl;
                  videoBLeftUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.b.videoLeftUrl;
                  videoBRightUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.b.videoRightUrl;
                  videoBBackUrl = baseUrl+fullRouteDetails.routeDetailsResources.latestResources.b.videoBackUrl;
                }
              }
                console.log('Parsing stage 2');

              if (fullRouteDetails.routeDetailsResources && fullRouteDetails.routeDetailsResources.latestResourcesLowResolution) {
                if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a) {
                  //console.log(fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a);
                  videoAUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.videoUrl;
                  videoALeftUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.videoLeftUrl;
                  videoARightUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.videoRightUrl;
                  videoABackUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.a.videoBackUrl;

                }
                  console.log('Parsing stage 2.1');
                if (fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b) {
                  videoBUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.videoUrl;
                  videoBLeftUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.videoLeftUrl;
                  videoBRightUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.videoRightUrl;
                  videoBBackUrlLowRes = baseUrl+fullRouteDetails.routeDetailsResources.latestResourcesLowResolution.b.videoBackUrl;
                }
              }

              console.log('Parsing stage 3');

              console.log('Starting now');


              //   tempRouteList[i] = routeObject;
              processVideoUrl(videoAUrl, function(videoAUrlResult) {
                if (videoAUrlResult) {
                  fullRouteDetails.routeDetails.a.videoUrl = videoAUrl;
                }else{
                  fullRouteDetails.routeDetails.a.videoUrl = "";
                }
                processVideoUrl(videoALeftUrl, function(videoALeftUrlResult) {
                  if (videoALeftUrlResult) {
                    fullRouteDetails.routeDetails.a.videoLeftUrl = videoALeftUrl;
                  }else{
                    fullRouteDetails.routeDetails.a.videoLeftUrl = "";
                  }
                  processVideoUrl(videoARightUrl, function(videoARightUrlResult) {
                    if (videoARightUrlResult) {
                      fullRouteDetails.routeDetails.a.videoRightUrl = videoARightUrl;
                    }else{
                      fullRouteDetails.routeDetails.a.videoRightUrl = "";
                    }
                    processVideoUrl(videoABackUrl, function(videoABackUrlResult) {
                      if (videoABackUrlResult) {
                        fullRouteDetails.routeDetails.a.videoBackUrl = videoABackUrl;
                      }else{
                          fullRouteDetails.routeDetails.a.videoBackUrl = "";
                      }
                      processVideoUrl(videoBUrl, function(videoBUrlResult) {
                        if (videoBUrlResult) {
                          fullRouteDetails.routeDetails.b.videoUrl = videoBUrl
                        }else{
                          fullRouteDetails.routeDetails.b.videoUrl = ""
                        }
                        processVideoUrl(videoBLeftUrl, function(videoBLeftUrlResult) {
                          if (videoBLeftUrlResult) {
                            fullRouteDetails.routeDetails.b.videoLeftUrl = videoBLeftUrl
                          }else{
                            fullRouteDetails.routeDetails.b.videoLeftUrl = ""
                          }
                          processVideoUrl(videoBRightUrl, function(videoBRightUrlResult) {
                            if (videoBRightUrlResult) {
                              fullRouteDetails.routeDetails.b.videoRightUrl = videoBRightUrl
                            }else{
                                fullRouteDetails.routeDetails.b.videoRightUrl = ""
                            }
                            processVideoUrl(videoBBackUrl, function(videoBBackUrlResult) {
                              if (videoBBackUrlResult) {
                                fullRouteDetails.routeDetails.b.videoBackUrl = videoBBackUrl
                              }else{
                                fullRouteDetails.routeDetails.b.videoBackUrl = ""
                              }

                              processVideoUrl(videoAUrlLowRes, function(videoAUrlResultLowRes) {
                                if (videoAUrlResultLowRes) {
                                  fullRouteDetails.routeDetails.a.videoUrlLowRes = videoAUrlLowRes;
                                }else{
                                  fullRouteDetails.routeDetails.a.videoUrlLowRes = "";
                                }
                                processVideoUrl(videoALeftUrlLowRes, function(videoALeftUrlResultLowRes) {
                                  if (videoALeftUrlResultLowRes) {
                                    fullRouteDetails.routeDetails.a.videoLeftUrlLowRes = videoALeftUrlLowRes;
                                  }else{
                                    fullRouteDetails.routeDetails.a.videoLeftUrlLowRes = "";
                                  }
                                  processVideoUrl(videoARightUrlLowRes, function(videoARightUrlResultLowRes) {
                                    if (videoARightUrlResultLowRes) {
                                      fullRouteDetails.routeDetails.a.videoRightUrlLowRes = videoARightUrlLowRes;
                                    }else{
                                        fullRouteDetails.routeDetails.a.videoRightUrlLowRes = "";
                                    }
                                    processVideoUrl(videoABackUrlLowRes, function(videoABackUrlResultLowRes) {
                                      if (videoABackUrlResultLowRes) {
                                        fullRouteDetails.routeDetails.a.videoBackUrlLowRes = videoABackUrlLowRes;
                                      }else{
                                        fullRouteDetails.routeDetails.a.videoBackUrlLowRes = "";
                                      }
                                      processVideoUrl(videoBUrlLowRes, function(videoBUrlResultLowRes) {
                                        if (videoBUrlResultLowRes) {
                                          fullRouteDetails.routeDetails.b.videoUrlLowRes = videoBUrlLowRes;
                                        }else{
                                            fullRouteDetails.routeDetails.b.videoUrlLowRes = "";
                                        }
                                        processVideoUrl(videoBLeftUrlLowRes, function(videoBLeftUrlResultLowRes) {
                                          if (videoBLeftUrlResult) {
                                            fullRouteDetails.routeDetails.b.videoLeftUrlLowRes = videoBLeftUrlLowRes
                                          }else{
                                            fullRouteDetails.routeDetails.b.videoLeftUrlLowRes = videoBLeftUrlLowRes
                                          }
                                          processVideoUrl(videoBRightUrlLowRes, function(videoBRightUrlResultLowRes) {
                                            if (videoBRightUrlResultLowRes) {
                                              fullRouteDetails.routeDetails.b.videoRightUrlLowRes = videoBRightUrlLowRes
                                            }else{
                                              fullRouteDetails.routeDetails.b.videoRightUrlLowRes = ""
                                            }
                                            processVideoUrl(videoBBackUrlLowRes, function(videoBBackUrlResultLowRes) {
                                              if (videoBBackUrlResultLowRes) {
                                                fullRouteDetails.routeDetails.b.videoBackUrlLowRes = videoBBackUrlLowRes
                                              }else{
                                                fullRouteDetails.routeDetails.b.videoBackUrlLowRes = ""
                                              }

                                              routeListArray[index] = fullRouteDetails;
                                              processRoute(index + 1);
                                            });
                                          });
                                        });
                                      });
                                    });
                                  });
                                });
                              });
                            });
                          });
                        });
                      });
                    });
                  });
                });
              });
            } else {
              callback(routeListArray)
            }
          }
          //callback(routeListArray)
          processRoute(0);
        },
        _startVideoUrlsAndStartKmlPrepareDataAndStartProcessing: function() {
          var self = this;
          var routes = [];
          var routesDetailses = [];
          var routesDetailsResources = [];
          this.$.saveOperationResultModal.close();
          this._showOperationResultModal(false, "loading data...please wait ");
          this.$.routeDataProcessing.getStoredValue('/settings')
            .then(function(data) {
              self._settings = data;
              console.log(self._settings);
              self.$.routeDataProcessing.getStoredValue('/routes')
                .then(function(data) {
                  // //console.log('Rotues Data');
                  // //console.log(data);
                  // //console.log(data.length);
                  routes = data;
                  self.$.routeDataProcessing.getStoredValue('/route-details-resources')
                        .then(function(data) {
                          routesDetailsResources = data;
                          self._combineRouteAndRouteDetails(routes, routesDetailsResources);
                        });

                }).catch(function(error) {
                  console.log(error);
                });
            }).catch(function(error) {
              console.log(error);
            });
        },
        _startVideoUrlsAndStartKmlProcessing: function() {
          var self = this;
          self.$.saveOperationResultModal.close();
          self._showOperationResultModal(false, "Routes video links and KML data getting processed, it will take a while");
          var tempRouteList = self._imported_routes_original;
          this._videoLinkBindingExistenceCheck(tempRouteList, function(bindedNewRouteListArray) {
            self._setKmlFiles(bindedNewRouteListArray, function(newRouteListArray) {
              console.log('Final Routes array before processing KML files');
              console.log(self._imported_routes);
              //self._setRoutes(newRouteListArray);
              self._imported_routes = newRouteListArray;
              self._imported_routes_original = newRouteListArray;
              console.log('Final Routes array after processing KML files');
              console.log(self._imported_routes);
              self.selectedTab = 1;
              self.$.saveOperationResultModal.close();
              self._showOperationResultModal(true, "All Routes avilable KML data process and updated below list, click on Batch import to update in firebase ");
              $('#mis_matched_routes').show();
              $('#mis_matched_routes').html('Mismatched routes: '+self._mismatchedRoutes.join(','));
              setTimeout(function() {
                self.$.saveOperationResultModal.close();
              }, 2000);
            });
          })

        },
        _setRoutes: function(routeListArray) {
          var self = this;
          this._imported_routes_original = routeListArray;

          console.log('Final Routes array');
          console.log(self._imported_routes);
          self.selectedTab = 1;
          this._startVideoUrlsAndStartKmlProcessing();
        },
        _combineRouteAndRouteDetails: function(routes, routeDetailsResources) {
          var self = this;
          var generatedVideoOnly = $('#generated_video_only').is(':checked');
          var finalRoutes = [];
          for (var routeKey in routes) {
            var tempRoute = routes[routeKey]
            if (tempRoute) {
              if(routeDetailsResources && routeDetailsResources[routeKey]){
                tempRoute.routeDetailsResources = routeDetailsResources[routeKey];
              }
              if(generatedVideoOnly){
                if(tempRoute.routeDetailsResources){
                  finalRoutes.push(tempRoute);
                }
              }else{
                finalRoutes.push(tempRoute);
              }

            }
          }

          // if ((routeDetailses && routeDetailses[routeKey] && routeDetailses[routeKey].a && routeDetailses[routeKey].a.stops) ||
          //     (routeDetailses && routeDetailses[routeKey] && routeDetailses[routeKey].b && routeDetailses[routeKey].b.stops)) {
          //   tempRoute.routeDetails = routeDetailses[routeKey];
          //   //tempRoute.routeDetails = this._routeDetails;
          //   console.log(tempRoute);
          //   finalRoutes.push(tempRoute);
          // }
          var finalSuitbleRoutes = [];
          var startMerge =  function(index){

            console.log('merge Index: '+index);
            if(index<finalRoutes.length){
              console.log('condition success')
              var fullRouteDetails = {};
              fullRouteDetails = finalRoutes[index];
              console.log('code: '+fullRouteDetails.code);
              self.$.routeDataProcessing.getStoredValue('/route-details-original/'+fullRouteDetails.code)
                .then(function(routeDetailsData) {
                 //self._combineRouteAndRouteDetails(routes,routesDetailses);
                 if(routeDetailsData && ((routeDetailsData.a && routeDetailsData.a.stops) || (routeDetailsData.b && routeDetailsData.b.stops))){
                   fullRouteDetails.routeDetails = routeDetailsData;
                   finalSuitbleRoutes.push(fullRouteDetails);
                 }
                 startMerge(index+1);
                }).catch(function(error) {
                  //console.log(error);
                });
            }else{
              console.log('Main Routes selection Done');
              console.log(finalSuitbleRoutes);
              self._setRoutes(finalSuitbleRoutes);
            }
          }
          startMerge(0);
          //
        },
        _toggleRoute: function(e) {
          var oldActiveRoute = Polymer.dom(this.root).querySelector('.item-wrapper.active');
          var paperButton;
          var routeIndex;
          var activeRoute;

          if (e.srcElement.localName === 'iron-icon') {
            paperButton = e.srcElement.parentNode;
          } else {
            paperButton = e.srcElement;
          }

          // Get the info of the selected route
          routeIndex = paperButton.getAttribute('data-route-index');
          activeRoute = Polymer.dom(this.root).querySelector('.item-wrapper[data-route-index="' + routeIndex + '"]');

          // Remove the active class
          if (oldActiveRoute) {
            oldActiveRoute.classList.remove('active');
          }

          // Check if the same route was collapsed
          if (oldActiveRoute !== activeRoute) {
            var routeMap = Polymer.dom(this.root).querySelector('#routeMap');

            activeRoute.classList.add('active');

            // Append the map element
            Polymer.dom(activeRoute.querySelector('.route-map')).appendChild(routeMap);
            this._activeRouteCode = activeRoute.getAttribute('data-route-code');
            this._videoGeoPointsOrigin = this._imported_routes[routeIndex].routeDetails.a.videoGeoPoints;

          }
        },

        _saveRoute: function(fullRouteData, callback) {
          var self = this;
          if (!fullRouteData) {
            return callback({
              message: 'data missing'
            }, false);
          }
          if (!fullRouteData.code) {
            return callback({
              message: 'data missing - before trim'
            }, false);
          }
          var code = fullRouteData.code.trim();
          if (!code) {
            return callback({
              message: 'Code missing - after trim'
            }, false)
          }


          var routeInfo = {
            code: fullRouteData.code,
            departure: fullRouteData.departure,
            destination: fullRouteData.destination,
            directionAName:fullRouteData.directionAName,
            directionBName: fullRouteData.directionBName,
            latitude: fullRouteData.latitude,
            longitude: fullRouteData.longitude,
            name: fullRouteData.name,
          };


          if(fullRouteData.routeDetails && fullRouteData.routeDetails.departure){
            routeInfo.departure = fullRouteData.routeDetails.departure;
          }
          if(fullRouteData.routeDetails && fullRouteData.routeDetails.destination){
            routeInfo.destination = fullRouteData.routeDetails.destination;
          }
          if(fullRouteData.routeDetails && fullRouteData.routeDetails.directionAName){
            routeInfo.directionAName = fullRouteData.routeDetails.directionAName;
          }
          if(fullRouteData.routeDetails && fullRouteData.routeDetails.directionBName){
            routeInfo.directionBName = fullRouteData.routeDetails.directionBName;
          }
          if(fullRouteData.routeDetails && fullRouteData.routeDetails.name){
            routeInfo.name = fullRouteData.routeDetails.name
          }
          var routeDetails = {
            a:fullRouteData.routeDetails.a,
            b:fullRouteData.routeDetails.b
          };

          if(!routeDetails.a){
            routeDetails.a = {};
          }
          if(!routeDetails.b){
            routeDetails.b = {};
          }
          var update = {};

          if (routeDetails.a && routeDetails.a.stops && routeDetails.a.stops.length) {
            for (var a = 0; a < routeDetails.a.stops.length; a++) {
              var tempStopObject = routeDetails.a.stops[a];
              var point = self.$.mapsUtils.getClosestPoint(tempStopObject.lat, tempStopObject.lng, routeDetails.a.videoGeoPoints);
              var sec = parseInt(point.key);
              if (!isNaN(sec)) {
                routeDetails.a.stops[a].sec = parseInt(point.key);
              } else {
                routeDetails.a.stops[a].sec = null;
              }

            }
          }

          if (routeDetails.b && routeDetails.b.stops && routeDetails.b.stops.length) {
            for (var b = 0; b < routeDetails.b.stops.length; b++) {
              var tempStopObject = routeDetails.b.stops[b];
              var point = self.$.mapsUtils.getClosestPoint(tempStopObject.lat, tempStopObject.lng, routeDetails.b.videoGeoPoints);
              var sec = parseInt(point.key);
              if (!isNaN(sec)) {
                routeDetails.b.stops[b].sec = parseInt(point.key);
              } else {
                routeDetails.b.stops[b].sec = null;
              }

            }
          }

          if(routeDetails.a && routeDetails.a.videoGeoPointsLeft){
            update['route-details-video-geopoints-left/'+code+'/a'] = routeDetails.a.videoGeoPointsLeft;
            delete routeDetails.a.videoGeoPointsLeft;
          }
          if(routeDetails.a && routeDetails.a.videoGeoPointsRight){
            update['route-details-video-geopoints-right/'+code+'/a'] = routeDetails.a.videoGeoPointsRight;
            delete routeDetails.a.videoGeoPointsRight;
          }
          if(routeDetails.a && routeDetails.a.videoGeoPointsBack){
            update['route-details-video-geopoints-back/'+code+'/a'] = routeDetails.a.videoGeoPointsBack;
            delete routeDetails.a.videoGeoPointsBack;
          }

          if(routeDetails.b && routeDetails.b.videoGeoPointsLeft){
            update['route-details-video-geopoints-left/'+code+'/b'] = routeDetails.b.videoGeoPointsLeft;
            delete routeDetails.b.videoGeoPointsLeft;
          }
          if(routeDetails.b && routeDetails.b.videoGeoPointsRight){
            update['route-details-video-geopoints-right/'+code+'/b'] = routeDetails.b.videoGeoPointsRight;
            delete routeDetails.b.videoGeoPointsRight;
          }
          if(routeDetails.b && routeDetails.b.videoGeoPointsBack){
            update['route-details-video-geopoints-back/'+code+'/b'] = routeDetails.b.videoGeoPointsBack;
            delete routeDetails.b.videoGeoPointsBack;
          }


          if(routeDetails.a && routeDetails.a.videoGeoPointsLowRes){
            update['route-details-video-geopoints-low-res-front/'+code+'/a'] = routeDetails.a.videoGeoPointsLowRes;
            delete routeDetails.a.videoGeoPointsLowRes;
          }

          if(routeDetails.a && routeDetails.a.videoGeoPointsLeftLowRes){
            update['route-details-video-geopoints-low-res-left/'+code+'/a'] = routeDetails.a.videoGeoPointsLeftLowRes;
            delete routeDetails.a.videoGeoPointsLeftLowRes;
          }

          if(routeDetails.a && routeDetails.a.videoGeoPointsRightLowRes){
            update['route-details-video-geopoints-low-res-right/'+code+'/a'] = routeDetails.a.videoGeoPointsRightLowRes;
            delete routeDetails.a.videoGeoPointsRightLowRes;
          }

          if(routeDetails.a && routeDetails.a.videoGeoPointsBackLowRes){
            update['route-details-video-geopoints-low-res-back/'+code+'/a'] = routeDetails.a.videoGeoPointsBackLowRes;
            delete routeDetails.a.videoGeoPointsBackLowRes;
          }



          if(routeDetails.b && routeDetails.b.videoGeoPointsLowRes){
            update['route-details-video-geopoints-low-res-front/'+code+'/b'] = routeDetails.b.videoGeoPointsLowRes;
            delete routeDetails.b.videoGeoPointsLowRes;
          }

          if(routeDetails.b && routeDetails.b.videoGeoPointsLeftLowRes){
            update['route-details-video-geopoints-low-res-left/'+code+'/b'] = routeDetails.b.videoGeoPointsLeftLowRes;
            delete routeDetails.b.videoGeoPointsLeftLowRes;
          }

          if(routeDetails.b && routeDetails.b.videoGeoPointsRightLowRes){
            update['route-details-video-geopoints-low-res-right/'+code+'/b'] = routeDetails.b.videoGeoPointsRightLowRes;
            delete routeDetails.b.videoGeoPointsRightLowRes;
          }

          if(routeDetails.b && routeDetails.b.videoGeoPointsBackLowRes){
            update['route-details-video-geopoints-low-res-back/'+code+'/b'] = routeDetails.b.videoGeoPointsBackLowRes;
            delete routeDetails.b.videoGeoPointsBackLowRes;
          }

          update['routes/' + code] = routeInfo;
          update['route-details/' + code] = routeDetails;

          console.log('check below update deep path');
          console.log(update)
          //return callback(null,true);
          var firebaseDb = this.$.routeInfo.db;
          var firebaseDbRef = firebaseDb.ref();
          firebaseDbRef.update(update, function(error) {
            if (error) {
              console.log("Error updating data:", error);
            } else {
              console.log('Write Success');
            }
            return callback(null, true);
          });
        },
        _batchImportRoutesListData: function(e) {
          var self = this;

          if (!this._imported_routes.length) {
            this.$.saveOperationResultModal.close();
            alert('Please Click on "Preview Route List" button first');
            return;
          }

          if (!confirm('Are you sure? This action will update All Video and KML data for routes in database and also overwrite existing routes data.')) {
            return false;
          }

          this._showOperationResultModal(false, "Route list data getting updated in firebase db, it will take a while, please wait...");

          var updateAble = 0;
          var self = this;
          var startUpdate = function(index) {
            if (index < self._imported_routes.length) {
              var fullRouteDetails = {};
              fullRouteDetails = self._imported_routes[index];
              var alreadyHadRouteInfoData = false;
              var alreadyHadRouteDetailsData = false;
              var code = fullRouteDetails.code.trim();
              self._saveRoute(fullRouteDetails, function(err, success) {
                if (err) {
                  console.log('There is a error to check')
                  console.log(err);
                }
                console.log('Success: ' + success);
                startUpdate(index + 1);
              })
            } else {
              self._showOperationResultModal(true, "All Routes Video and KML data in firebase db");
              setTimeout(function() {
                self.$.saveOperationResultModal.close();
              }, 2000);
              return;
            }
          }
          startUpdate(0);
        },
        ready: function() {
          var self = this;
          this.$.routeDataProcessing.getStoredValue('/settings/video_generation_server_url')
            .then(function(data) {
              self._video_generation_server_url = data;
            });
        },
      });
    })();
  </script>
</dom-module>
