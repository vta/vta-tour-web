<dom-module id="route-navigation">
  <template>
    <style is="custom-style" include="shared-styles"></style>
    <style>
      :host {
        display: block;
        position: relative;
      }

      paper-progress {
        --paper-progress-active-color: #44B5E3;
        width: 100%;
        cursor: pointer;
        height: 10px;
        --paper-progress-height: 10px;
        margin-top: -1.4%;
        --paper-progress-container-color: rgba(224, 224, 224, 0.4);
      }


      .video-controls {
        @apply(--layout-horizontal);
        background-color: var(--primary-color);
        width: 100%;
        height: 56px;
        position: fixed;
        bottom: 0;
      }

      .video-controls paper-button {
        @apply(--layout-flex);
        background-color: var(--primary-color);
        display: block;
        margin: 0;
        padding: 0.5em;
        text-align: center;
        text-transform: none;
      }

      .video-controls paper-button[disabled] {
        opacity: 0.5;
      }

      .video-controls paper-button .button-copy {
        display: block;
        width: 100%;
      }

      google-map {
        height: 400px;
      }

      poi-list,
      poi-detail {
        background-color: var(--vta-light-gray);
        display: none;
        position: absolute;
        top: -29px;
        left: 0;
        width: 100%;
        min-height: 110%;
        margin-bottom: 56px;
      }

      poi-list.active,
      poi-detail.active {
        display: block;
      }
      #route-list-display{
        width:100%;
        text-align:center;
        font-size:14px;
        color:#02528a;
        /* border-bottom:1px solid #02528a; */
        /* border-top:1px solid #02528a; */
        background-color:#ffff;
      }
      #direction-display{
        width:100%;
        text-align:center;
        font-size:16px;
        color:#02528a;
        /* border-bottom:1px solid #02528a; */
        /* border-top:1px solid #02528a; */
        background-color:#ffff;
      }



      @media all and (min-width: 361px) and (orientation: landscape) {
        .navigation-wrapper {
          @apply(--layout-horizontal);
          margin: 0px 0px;
        }

        .video-player-wrapper,
        .map-wrapper {
          @apply(--layout-flex);
        }

        /* .video-player-wrapper {
          margin-right: 10px;
        } */
      }

      /* Styles of the POI list and details for desktop version */
      @media all and (min-width: 600px) and (orientation: landscape) {
        .poi-wrapper{
          position: absolute;
          top: -20px;
          left: 0;
          width: 100%;
          @apply(--layout-horizontal);
          background-color: var(--vta-light-gray);
          z-index: 100;
        }

        poi-list,
        poi-detail {
          position: relative;
        }

        poi-list{
          width: 30%;
          min-width: 300px;
          max-height: 900px;
          overflow-y: auto;

        }
        poi-detail {
          @apply(--layout-flex);
          margin-left: 16px;
          min-height: 500px;
        }
      }

      .icon,#secondery-back-link{
        cursor: pointer;
      }

      .background-color{
        /* margin-top: 7%; */
        position: fixed;
        bottom: 0;
      }
      .spacer_div{
        display: none;
      }
      /*  Extra Media queries */

      @media all and (min-width: 768px) and (max-width: 980px) {

      }
      @media all and (max-width: 768px) {
        #spacer_div{
          display: block;
        }
          .top-header{
              height:50px !important;
              /* margin-left: 10px!important */
          }
          .arrow-icons{
            margin-top: -1px !important;
            height: 25px;
            position: absolute;
            margin-left: -32px!important
          }
          .top-header .header-item{
            margin-left: 3px !important;
          }
      }
      @media (max-width: 480px) {
        .navbar-header{
          margin: 2px 0 !important;
        }

        #direction-display{
          font-size: 12px;
        }
        #route-list-display{
            font-size: 12px;
        }

        .navbar-collapse{
          display:none;
        }

        .f-box{
          padding:0px!important;
          padding-top:5%!important;
        }
        .f-box h2{
          font-size: 10px!important;
        }
        /* .f-box img{
          width: 16px !important;
        }
        .background-color{
          height:5%;
        }
        .f-box i{
          font-size: 15%;
        }
        .top-header .header-item{
          font-size: 12px;
        } */

        /* .arrow-icons{
          margin-top: 3%!important;
          height: 25px;
          position: absolute;
          margin-left: -32px!important
        }
        .top-header .header-item{
          margin-left: 3px !important;
          margin-top: -3%;
        } */
        #secondery-back-link{
          height: 15px;
          margin-top: 4px !important;
          margin-left: -25px !important;
        }

      }
      .fullscreen-button{
        /* position: absolute; */
        z-index: 9999999;
        --iron-icon-height: 30px;
        /* margin-left: 46%; */
        margin-top: 3px;
        color: white;
        cursor: pointer;
        float:right;
        margin-right: 10px;
      }



      @media (max-width:320px) {
        .top-header .header-item{
          font-size: 12px;
          margin-top: -3px;
        }
        #secondery-back-link{
          height: 15px;
          margin-top: 9px !important;
          margin-left: -25px !important;
        }


      }



    </style>
      <iron-media-query query="(min-width: 600px) and (orientation: landscape)" query-matches="{{isDesktop}}"></iron-media-query>
      <firebase-document
        app-name="vta"
    	  id="routeDetails"
        data="{{_routeDetailsOrigin}}">
      </firebase-document>
      <firebase-document
        app-name="vta"
        id="routeInfo"
        data="{{_routeInfoOrigin}}">
      </firebase-document>
      <template is="dom-if" if="[[_routeInfo]]" >
      <div class="top-header">
              <div class="container-fluid header-area">
                  <div class="pull-left">
                      <div class="header-item"><img class="arrow-icons" src="../../images/back.svg" alt="" on-click="_goBack" id="secondery-back-link">[[_routeDirection]] / V Tour /  [[_routeInfo.name]]</div>
                  </div>
                  <div class="pull-right  ">
                  </div>
                  <!-- #top-social end -->
              </div>
        </div>
      </template>

      <div class="inner-content" style="display:none;">
      	<h2 class="page-title" tabindex="-1">[[_routeInfo.name]] - [[_routeDirection]]</h2>

      </div>

      <div class="navigation-wrapper">
        <div class="video-player-wrapper">
            <iron-icon icon="icons:fullscreen" class="fullscreen-button"></iron-icon>
          <video id="mainRouteVideo" class="video-js vjs-default-skin" controls preload="auto" webkit-playsinline playsinline>
                <!-- <source src="https://s3-us-west-1.amazonaws.com/vta-tour-rtmp/ALUMROCKTRANSITCENTER-SANTACLARA%2628TH/1024x1024-SANTA_CLARA_28TH-ALUM_ROCK_TRANSIT_CENTER.mp4" type='video/mp4'> -->
                <p class="vjs-no-js">
                  To view this video please enable JavaScript, and consider upgrading to a web browser that
                  <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
                </p>
          </video>
          <paper-progress value="{{_progressBarValue}}" on-click="_videoProgressClick" class="blue"></paper-progress>
        </div>

        <div class="map-wrapper">
          <google-map-search
            id="search"
            map="[[_map]]"
            api-key="AIzaSyCRa-TDLoCJRQmekLjUiU5tI9HXnWijLu4"
            radius="3000"
            results="{{_pois}}"
            mapType="satellite"
            >
          </google-map-search>

          <google-map id="map"
            map="{{_map}}"
            api-key="AIzaSyCRa-TDLoCJRQmekLjUiU5tI9HXnWijLu4"
            additional-map-options='{"zoomControl":"true"}'
            mapType="satellite"
            disable-zoom>
              <template is="dom-if" if="[[_isValidCords(_currentLat,_currentLng)]]">
                <google-map-marker id="marker" icon="/images/fa-bus.png"
                  latitude="{{_currentLat}}" longitude="{{_currentLng}}">
                </google-map-marker>
              </template>

              <template is="dom-if" if="[[_isValidCords(_departureStop.lat,_departureStop.lng)]]">
                  <google-map-marker
                    id="departureMarker"
                    latitude="[[_departureStop.lat]]"
                    longitude="[[_departureStop.lng]]"
                    icon="/images/fa-map-marker-origin.png"
                    click-events
                    on-google-map-marker-click="_onPoiClick">
                    <h3>{{_departureStop.name}}</h3>
                  </google-map-marker>
              </template>

              <template is="dom-if" if="[[_isValidCords(_destinationStop.lat,_destinationStop.lng)]]">
                <google-map-marker
                  id="destinationMarker"
                  latitude="[[_destinationStop.lat]]"
                  longitude="[[_destinationStop.lng]]"
                  icon="/images/fa-map-marker-destination.png"
                  click-events
                  on-google-map-marker-click="_onPoiClick">
                  <h3>{{_destinationStop.name}}</h3>
                </google-map-marker>
              </template>


                <template is="dom-if" if="[[_isValidCords(_nextStopGeoPoint.lat,_nextStopGeoPoint.lng)]]">
                  <google-map-marker
                    id="nextStopMarker"
                    latitude="[[_nextStopGeoPoint.lat]]"
                    longitude="[[_nextStopGeoPoint.lng]]"
                    icon="{{_getStopIcon()}}"
                    click-events
                    on-google-map-marker-click="_onPoiClick"
                    hidden>
                  </google-map-marker>
                </template>


            <template is="dom-repeat" items="[[_routeDetails.stops]]" as="stopObj">
                <template is="dom-if" if="[[_isValidCords(stopObj.lat,stopObj.lng)]]">
                  <template is="dom-if" if="[[_isInValidRange(stopObj.sec)]]">
                      <google-map-marker latitude="[[stopObj.lat]]" longitude="[[stopObj.lng]]" data-sec="[[stopObj.sec]]"
                        click-events on-google-map-marker-click="_onStopIconClick" icon="{{_getStopIcon()}}"
                        hidden$="{{!_isValidZoom}}"
                        >
                        <span style="display:none">[[stopObj.sec]]</span>
                        <h2>[[stopObj.name]]</h2>
                      </google-map-marker>
                  </template>
                </template>
            </template>

            <template is="dom-repeat" items="{{_pois}}" as="poi">
              <google-map-marker latitude="{{poi.latitude}}" longitude="{{poi.longitude}}"
                click-events on-google-map-marker-click="_onPoiClick" icon="/images/poi-pointer.png">
                <h2>{{poi.name}}</h2>
                <span>{{poi.formatted_address}}</span>
              </google-map-marker>
            </template>
          </google-map>
        </div>
        <google-maps-api api-key="AIzaSyCRa-TDLoCJRQmekLjUiU5tI9HXnWijLu4" library-loaded="{{_mapsApiLoaded}}" on-api-load="_onMapsApiLoad"></google-maps-api>
      </div>

      <div class="poi-wrapper">
        <poi-list id="pois" pois="{{_pois}}" selected="{{_selectedPoi}}"></poi-list>
        <poi-detail id="poiDetails" place-details="{{_selectedPoiDetails}}"
          lat-origin="{{_nextStopGeoPoint.lat}}" lng-origin="{{_nextStopGeoPoint.lng}}"></poi-detail>
      </div>

      <br>
<br/>

    <div id="spacer_div" clss="spacer_div"><br/></div>
    <div id="spacer_div_2" clss="spacer_div"><br/></div>
    <div id="spacer_div_3" clss="spacer_div"><br/></div>
    <div id="spacer_div_4" clss="spacer_div"><br/></div>


      <div class="background-color">
      <template is="dom-if" if="[[_nextStop]]" >
      <div id="route-list-display" hidden$="{{!_startedOnce}}">[[_nextStop.name]]
        <template is="dom-if" if="[[_nextStop.route_list]]">
        (Connects - [[_nextStop.route_list]])
         </template>
      </div>
     </template>
      <div id="direction-display" hidden$="{{!_startedOnce}}"></div>
      <div class="container">
          <div class="row">
              <!--feature start-->
              <div class="button-area">
              <div class="col-lg-3 col-sm-3 col-xs-3 icon" id="restartVideo" on-click="_restartVideo" title="Restart">
                  <section>
                      <div class="f-box">
                          <i><img style=" width:30px;" src="../../images/restart.svg" alt=""></i>
                          <a href="javascript:void(0);"><h2>RESTART</h2></a>
                      </div>

                  </section>
              </div>
              <div class="col-lg-3 col-sm-3 col-xs-3 icon" id="playVideo" on-click="_playVideo" hidden$="{{_shouldHidePlay}}" disabled$="{{!_startedOnce}}" title="Play">
                  <section>
                      <div class="f-box ">
                          <i><img style=" width:30px;" src="../../images/play.svg" alt=""></i>
                           <a href="javascript:void(0);"><h2>PLAY</h2></a>
                      </div>

                  </section>
              </div>
              <div class="col-lg-3 col-sm-3 col-xs-3 icon" id="pauseVideo" on-click="_pauseVideo" hidden$="{{!_isVideoPlaying}}" title="Pause">
                  <section>
                      <div class="f-box ">
                          <i><img style=" width:30px;" src="../../images/pause.svg" alt=""></i>
                           <a href="javascript:void(0);"><h2>PAUSE</h2></a>
                      </div>

                  </section>
              </div>
              <div style=" border-right:1px solid #fff" class="col-lg-3 col-sm-3 col-xs-3 icon" id="stopVideo" on-click="_stopVideo" disabled title="View PIO's">
                  <section>
                      <div class="f-box">
                           <i><img style=" width:30px;" src="../../images/view.svg" alt=""></i>
                           <a href="javascript:void(0);"><h2>VIEW PIOs</h2></a>
                      </div>

                  </section>
              </div>
              <div style=" border-right:1px solid #fff" class="col-lg-3 col-sm-3 col-xs-3 icon" id="navigationAction" on-click="_pauseVideo"  title="Navigation" >
                <a href="https://www.google.com/maps/dir/?api=1&origin=[[_departureStop.lat]],[[_departureStop.lng]]&destination=[[_destinationStop.lat]],[[_destinationStop.lng]]" target="_blank">
                  <section>
                      <div class="f-box">
                           <i><img style=" width:30px;" src="../../images/navigation.svg" alt=""></i>
                           <h2>NAVIGATION</h2>
                      </div>

                  </section>
                  </a>
              </div>
              </div>
              <!--feature end-->
          </div>

      </div>
    </div>

      <!-- <div class="video-controls" >
        <paper-button id="restartVideo" on-click="_restartVideo" disabled$="{{!_startedOnce}}">
          <iron-icon icon="vta-icons:restart"></iron-icon>
          <span class="button-copy">Restart</span>
        </paper-button>
        <paper-button id="playVideo" on-click="_playVideo" hidden$="{{_shouldHidePlay}}">
          <iron-icon icon="vta-icons:play"></iron-icon>
          <span class="button-copy">Play</span>
        </paper-button>
        <paper-button id="pauseVideo" on-click="_pauseVideo" hidden$="{{!_isVideoPlaying}}">
          <iron-icon icon="vta-icons:pause"></iron-icon>
          <span class="button-copy">Pause</span>
        </paper-button>
        <paper-button id="stopVideo" on-click="_stopVideo" disabled>
          <iron-icon icon="vta-icons:stop"></iron-icon>
          <span class="button-copy">View POIs</span>
        </paper-button>
      </div> -->
      <maps-utils id="mapsUtils" on-pois-loaded="_poisLoaded"></maps-utils>
    </template>
</dom-module>

<script>
var map;
	(function() {
    'use strict';
    try{
      Polymer({
        is: 'route-navigation',
        properties: {
          player: {
            type: Object
          },
        	code: {
        		type: String,
        		observer: '_initialPropertyChange'
        	},
          direction: {
        		type: String,
        		observer: '_initialPropertyChange'
        	},
        	departureStopId: {
        	  type: String,
        	  observer: '_initialPropertyChange'
        	},
        	destinationStopId: {
            type: String,
            observer: '_initialPropertyChange'
        	},
          _departure: {
            type: Object
          },
          _destination: {
            type: Object
          },
          _nextStopGeoPoint: {
            type: Object,
            value: {
              lat: null,
              lng: null
            }
          },
          _startedOnce: {
            type: Boolean,
            value: false
          },
          _playsupported: {
            type: Boolean,
            observer: '_playsupportedChange'
          },
          _shouldHidePlay : {
            type: Boolean,
            value: true
          },
          _isVideoPlaying: {
            type: Boolean,
            value: false,
            observer: '_isVideoPlayingChange'
          },
          _map : {
            type: Object
          },
        	_tempRouteParams: {
        	  type: Object,
        	  value: {}
        	},
        	_routeDetails : {
        	  type: Object,
            value: null,
        	  observer: '_routeDetailsChange'
        	},
          _routeDetailsOrigin : {
            type: Object,
            value: null,
            observer: '_routeDetailsOriginChange'
          },
        	_routeInfo : {
        	  type: Object,
        	  observer: '_routeInfoChange'
        	},
          _routeInfoOrigin : {
            type: Object,
            observer: '_routeInfoOriginChange'
          },
        	_videoStartTime: {
        	  type: Number,
        	  value: 0
        	},
          _videoEndTime: {
            type: Number,
            value: -1
          },
        	_videoCurrentTime: {
        	  type: Number,
        	  observer: '_videoCurrentTimeChange'
        	},
          _isValidZoom: {
            type: Boolean,
            value: false,
          },
        	_videoState: {
        	  type: Number,
        	  observer: '_videoStateChange'
        	},
          _progressBarValue: {
            type: Number
          },
          _isDragging: {
            type: Boolean,
            value: false
          },
          _pois: {
            type: Array,
            value: []
          },
          _selectedPoi: {
            type: Object,
            observer: '_selectedPoiChange'
          },
          _selectedPoiMarker: {
            type : Object
          },
          _currentLat: {
            type: Number
          },
          _currentLng: {
            type: Number
          },
          _direction: {
            type: Boolean
          },
        },

        SECONDS_INTERVAL_FOR_STOPS : 10,

        clearRouteSelection: function() {
          this.code = null;
          this.departureStopId = null;
          this.destinationStopId = null;
          this._videoCurrentTime = 0;
          this._routeDetails = null;
          this._routeInfo = null;
          this.$.routeDetails.path = null;
          this.$.routeInfo.path = null;
          this._pois = [];
          this._direction = false;
          this.reFocused = false;
          this._isValidZoom = false;

          if (this._mapPolyline) {
            this._mapPolyline.setMap(null);
          }
          this._videoViewChange("");
          $('.SelectViewItems').hide();
          $('#viewSelectionText').text("VIEWS");
        },

        _initialPropertyChange: function() {
          // Load the route details and information from Firebase only when the
          // code, direction, departure stop ID and destination stop ID are set
          if (this.code && this.direction && this.departureStopId && this.destinationStopId) {
            var routePath = this.code + '/' + this.direction;

            // Set the proper attributes to load the route data from Firebase
            this.$.routeDetails.path = '/route-details/' + routePath;
            this.$.routeInfo.path = '/routes/' + this.code;
          }
        },

        _routeDetailsChange: function(newRouteDetails) {
          this._adjustMapSize();
          if (!newRouteDetails || (!this.departureStopId && !this.destinationStopId)) {
            return;
          }

          console.log('check new route details')
          console.log(newRouteDetails)

          this._assignSource(newRouteDetails.videoUrl);

          if(newRouteDetails.videoUrl){
            $('#frontView').show().attr('data-video',newRouteDetails.videoUrl);
          }else{
            $('#frontView').hide();
          }
          if(newRouteDetails.videoLeftUrl){
            $('#leftView').show().attr('data-video',newRouteDetails.videoLeftUrl);
          }else{
            $('#leftView').hide();
          }
          if(newRouteDetails.videoRightUrl){
            $('#rightView').show().attr('data-video',newRouteDetails.videoRightUrl);
          }else{
            $('#rightView').hide();
          }
          if(newRouteDetails.videoBackUrl){
            $('#backView').show().attr('data-video',newRouteDetails.videoBackUrl);
          }else{
            $('#backView').hide();
          }
          if(newRouteDetails.videoNightUrl){
            $('#nightView').show().attr('data-video',newRouteDetails.videoNightUrl);
          }else{
            $('#nightView').hide();
          }

          // Get the departure and destination points based on the closest points to the stops

          var departurePoint = this.$.mapsUtils.getClosestPoint(newRouteDetails.stops[this.departureStopId].lat,
            newRouteDetails.stops[this.departureStopId].lng, newRouteDetails.videoGeoPoints);
          var destinationPoint = this.$.mapsUtils.getClosestPoint(newRouteDetails.stops[this.destinationStopId].lat,
            newRouteDetails.stops[this.destinationStopId].lng, newRouteDetails.videoGeoPoints);

          var departurePointInt = parseInt(departurePoint.key);
          var destinationPointInt = parseInt(destinationPoint.key);

          // Get the tour slot based on the start and end points
          var tourSlot = this.getRouteSlot(newRouteDetails.videoGeoPoints, departurePointInt, destinationPointInt);

          // Set the names of the departure and destination stops
          console.log('checking below departure');
          console.log(newRouteDetails.stops[this.departureStopId]);

          this._departureStop = newRouteDetails.stops[this.departureStopId];
          // if(this._departureStop){
          //   this._currentLat = parseFloat(this._departureStop.lat);
          //   this._currentLng = parseFloat(this._departureStop.lng);
          //   this._map.panTo({
          //     lat:this._currentLat,
          //     lng:this._currentLng,
          //   })
          //   this._map.setZoom(16);
          // }
          this._destinationStop = newRouteDetails.stops[this.destinationStopId];
          if(this.$.departureMarker){
            this.$.departureMarker.info = this.$.mapsUtils.getMarkerObj('<h3>' + this._departureStop.name + '</h3>');
          }

          if(this.$.destinationMarker){
            this.$.destinationMarker.info = this.$.mapsUtils.getMarkerObj('<h3>' + this._destinationStop.name + '</h3>');
          }


          // Set the start and end times of the video based on the departure and destination stops
          this._videoStartTime = parseInt(departurePoint.key);
          this._videoEndTime = parseInt(destinationPoint.key);
          if(this.player.duration()<this._videoStartTime){
            this.player.pause();
          }else{
            this.player.currentTime(this._videoStartTime);
          }


          // Set the next stop
          if(this.departureStopId < this.destinationStopId){
            this._stopsSlot = newRouteDetails.stops.slice(this.departureStopId, parseInt(this.destinationStopId) + 1);
          }else{
            this._stopsSlot = newRouteDetails.stops.slice(this.destinationStopId, parseInt(this.departureStopId) + 1).reverse();
          }

          this._nextStop = this._calculateNextStop(this._stopsSlot, this._videoStartTime);

          // Load the route path with the tour slot select by the user
          var self = this;
          setTimeout(function(){
              self._loadRoutePath(tourSlot);
          },1000);


        },

        _routeDetailsOriginChange: function(newRouteDetailsOrigin) {
          if (newRouteDetailsOrigin && newRouteDetailsOrigin.videoUrl) {
            this._routeDetails = newRouteDetailsOrigin;
          }
        },

        _routeInfoChange: function(newRouteInfo) {
          if (newRouteInfo) {
            var routeDirectionName = '';

            if (this.direction === 'a') {
              routeDirectionName = newRouteInfo.directionAName;
            } else if (this.direction === 'b') {
              routeDirectionName = newRouteInfo.directionBName;
            }

            this._routeDirection = routeDirectionName;
          }
        },

        _routeInfoOriginChange: function(newRouteInfoOrigin) {
          if (newRouteInfoOrigin && newRouteInfoOrigin.name) {
            this._routeInfo = newRouteInfoOrigin;
          }
        },

        _calculateMapHeight: function() {
          var getElementHeight = function(element) {
              var elmHeight, elmMargin;

              if (document.all) {// IE
                elmHeight = element.currentStyle.height;
                elmMargin = parseInt(element.currentStyle.marginTop, 10) + parseInt(element.currentStyle.marginBottom, 10);
              } else {// Mozilla
                var computedStyle = document.defaultView.getComputedStyle(element, '');

                elmHeight = element.offsetHeight;
                elmMargin = parseInt(computedStyle.getPropertyValue('margin-top')) + parseInt(computedStyle.getPropertyValue('margin-bottom'));
              }

              return (elmHeight + elmMargin);
          }

          var windowHeight = window.outerHeight;
          var mainToolbarHeight = Polymer.dom(document).querySelector('#mainToolbar').offsetHeight;
          var pageTitleHeight = getElementHeight(Polymer.dom(this.root).querySelector('.page-title'));
          var videoHeight = Polymer.dom(this.root).querySelector('#mainRouteVideo').offsetHeight;
          var videoProggressHeight = Polymer.dom(this.root).querySelector('paper-progress').offsetHeight;
          var videoControlsHeight = Polymer.dom(this.root).querySelector('.video-controls').offsetHeight;

          return windowHeight - mainToolbarHeight - pageTitleHeight - videoHeight - videoProggressHeight - videoControlsHeight;
        },

        _setEndMessage: function(){
          var endRouteListMessage = "";
          var route_list ="";
          if(this._destinationStop && this._destinationStop.route_list){
            route_list = this._destinationStop.route_list.toString();
            var routeListArray = route_list.split(',');
            if(routeListArray.length==1){
              endRouteListMessage = ', Connection is available for route: '+this._destinationStop.route_list
            }else if(routeListArray.length>1){
              endRouteListMessage = ', Connections are available for routes: '+this._destinationStop.route_list
            }

          }
          $('#direction-display').html('Reached destination'+endRouteListMessage);
          // var endStopMessage = this._destinationStop.name;
          // if(this._destinationStop.route_list){
          //   endStopMessage+' (connects - '+this._destinationStop.route_list+')';
          // }
          // $('#route-list-display').html(endStopMessage);
        },

        _videoCurrentTimeChange: function(newVideoCurrentTime) {
          if (!this._routeDetails || !this.player) {
            return;
          }
          if(this._map.getZoom() >= 14){
            this._isValidZoom = true;
          }else{
            this._isValidZoom = false;
          }


          if(parseFloat(this.player.duration())<0){
              return;
          }

          console.log('current Time: '+newVideoCurrentTime)
          console.log('duration: '+this.player.duration());
          var finalPoint = {
            lat: this._destinationStop.lat,
            lng:this._destinationStop.lng
          }
          // Check if the video reaches the end of the tour
          if(newVideoCurrentTime<this._videoStartTime){
            this.player.currentTime(this._videoStartTime);
          }
          if(newVideoCurrentTime == (this._videoEndTime+1)){
            this._currentLat = parseFloat(finalPoint.lat);
            this._currentLng = parseFloat(finalPoint.lng);
            this._map.panTo(finalPoint);
            this.player.pause();
            this._setEndMessage();
            return;
          }else if(newVideoCurrentTime > (this._videoEndTime+1)){
            this._currentLat = parseFloat(finalPoint.lat);
            this._currentLng = parseFloat(finalPoint.lng);
            this._map.panTo(finalPoint);
            this.player.pause();
            this.player.currentTime(this._videoEndTime);
            this._setEndMessage()
            return;
          }else if (newVideoCurrentTime >= this.player.duration()) {
            this._currentLat = parseFloat(finalPoint.lat);
            this._currentLng = parseFloat(finalPoint.lng);
            this._map.panTo(finalPoint);
            this.player.pause();
            return;
          }

          console.log('zoom level: '+this._map.getZoom());

          var point = this._routeDetails.videoGeoPoints[newVideoCurrentTime - 1];
          var nextPoint = this._routeDetails.videoGeoPoints[newVideoCurrentTime];
          if(point && nextPoint && point.lat && point.lng && nextPoint.lat && nextPoint.lng){
            var currentLatLong = point.lat +','+point.lng;
            var nextLatLong = nextPoint.lat +','+nextPoint.lng;
            this._getDirectionData(currentLatLong,nextLatLong);
          }
          // Calculate the progress bar value
          this._progressBarValue = this._calculateVideoProgress(this._videoStartTime, this._videoEndTime, newVideoCurrentTime);

          if (point && !isNaN(parseFloat(point.lat)) && !isNaN(parseFloat(point.lng))) {
            console.log('check lat and lng');
            console.log(point.lat);
            console.log(point.lng);
            this._currentLat = parseFloat(point.lat);
            this._currentLng = parseFloat(point.lng);
            this._map.panTo(point)
            if(this._map.getZoom() < 16 && !this.reFocused){
              this._map.setZoom(16);
              this.reFocused = true;
            }
          }
          console.log('point');
          console.log(point);
          console.log('Current lat-lng: '+this._currentLat +'-'+this._currentLng);

          // Check if the video current time is in the range of the next stop
          if (this._nextStop && newVideoCurrentTime >= this._nextStop.sec &&
              newVideoCurrentTime < this._nextStop.endSec && this.$.nextStopMarker &&
              this.$.nextStopMarker.hidden === true) {
            this._nextStopGeoPoint.lat = parseFloat(this._nextStop.lat);
            this._nextStopGeoPoint.lng = parseFloat(this._nextStop.lng);
            this.notifyPath('_nextStopGeoPoint.lat', this._nextStop.lat);
            this.notifyPath('_nextStopGeoPoint.lng', this._nextStop.lng);
            this._enableNextStop();
          } else if (this._nextStop && newVideoCurrentTime > this._nextStop.endSec) {
            this._nextStop = this._calculateNextStop(this._stopsSlot, newVideoCurrentTime);
            this._disableNextStop();
          }else{
              this._nextStop = this._calculateNextStop(this._stopsSlot, newVideoCurrentTime);
          }
        },

        _calculateVideoProgress: function(start, end, actual) {
          var total = end - start;
          var current = actual - start;
          return current * 100 / total;
        },

        _calculateVideoSeconds: function(start, end, percentage) {
          var startNumber = parseInt(start);
          var endNumber = parseInt(end);
          var total = endNumber - startNumber;
          var seconds = total * percentage / 100;
          return seconds + startNumber;
        },

        _videoStateChange: function(newVideoState, oldVideoState) {
          // Check if the video hasn't been started to search for the first position
          if (oldVideoState === -1 && (newVideoState === 1 || newVideoState === 3)) {
            var second = Math.round(this._videoStartTime);
            this.player.currentTime(second, false);
          }
          // Check each state of the video to see which buttons to enable/disable
          if (newVideoState !== -1) { // unstarted
            this.$.restartVideo.disabled = false;
            if (newVideoState === 1) { // playing
              this.$.playVideo.disabled = true;
              this._isVideoPlaying = true;
              // resize the map on play
              this._adjustMapSize();
            } else {
              this.$.playVideo.disabled = false;
              this._isVideoPlaying = false;
            }
          }
        },

        _isVideoPlayingChange: function(){
          this._shouldHidePlay = !this._canShowPlay();
        },

        _playsupportedChange: function(){
          this._shouldHidePlay = !this._canShowPlay();
          if(this._playsupported){
            this._adjustMapSize();
          }
        },

        _canShowPlay : function(){
          return this._playsupported && !this._isVideoPlaying;
        },

        _restartVideo: function() {
          this.player.currentTime(0);
          this.player.play();
          // this.player.currentTime(this._videoStartTime);
          this._nextStop = this._calculateNextStop(this._stopsSlot, this._videoStartTime);

          $('#direction-display').html('');

          // Send the event to Google Analytics
          ga('send', 'event', 'Tour', 'restart', this._routeInfo.name);
        },


        _playVideo: function() {
          // If its on poi list or detail go back to navigation page.
          this._back();
          //_playVideo
          this.player.play();
          this._shouldHidePlay = true;
          this._isVideoPlaying = true;
          this._startedOnce = true;

          if (this._pois) {
            this._pois = null;
          }
          // Send the event to Google Analytics
          ga('send', 'event', 'Tour', 'play', this._routeInfo.name);
        },

        _pauseVideo: function() {
          this.player.pause();
          this._shouldHidePlay = false;
          this._isVideoPlaying = false;
          // this.$.routeVideo.pause();
          // this.$.mapsUtils.getPoisFromLocation(this._currentLat, this._currentLng, this._map);

          // Send the event to Google Analytics
          if(this._routeInfo){
            ga('send', 'event', 'Tour', 'pause', this._routeInfo.name);
          }
        },
        _endVideo: function() {
          this._shouldHidePlay = true;
          this._isVideoPlaying = false;
          // this.$.routeVideo.pause();
          // this.$.mapsUtils.getPoisFromLocation(this._currentLat, this._currentLng, this._map);

          // Send the event to Google Analytics
          ga('send', 'event', 'Tour', 'end', this._routeInfo.name);
        },
        _stopVideo: function() {
          var self = this;

          this.player.pause();
          //this.$.routeVideo.pause();
          this.$.mapsUtils.getPoisFromLocation(this._currentLat, this._currentLng, this._map);

          // Send the event to Google Analytics
          ga('send', 'event', 'Tour', 'stop', this._routeInfo.name);

          page(page.current + "/pois");
        },

        _videoProgressClick: function(progressBar) {
          var clickPercentage = progressBar.layerX * 100 / progressBar.srcElement.clientWidth;
          var progressSeconds = this._calculateVideoSeconds(this._videoStartTime, this._videoEndTime, clickPercentage);
          this._nextStop = this._calculateNextStop(this._stopsSlot, progressSeconds);
          this.player.currentTime(progressSeconds);
        },

        /**
         * Method to handle the maps api load event.
         * Binds the mousedown listener to move the marker.
         * Disable the marker's move when the user is dragging inside the map.
         */
        _onMapsApiLoad : function(){
          var self = this;
          console.log('Maps Api Loaded');
          setTimeout(function(){
            google.maps.event.addListener(self._map, 'mouseup', function(event){
              if(!self._isDragging && event.latLng){
                self._moveMarker(event.latLng);
              }
            });
            google.maps.event.addListener(self._map, 'zoom_changed', function(event){
              console.log('zoom event changed')
              self._calculateValidZooomStatus();
            });

            google.maps.event.addListener(self._map, 'dragstart', function(event){
              self._isDragging = true;
            });

            google.maps.event.addListener(self._map, 'dragend', function(event){
              self._isDragging = false;
            });
          },1000);

        },

        /**
         * Draw a line in the map using the route geo points. Centers the map in the line.
         *
         * @param points array with the geo points
         */
        _loadRoutePath : function(points){

          if(!points || !this._mapsApiLoaded){
            return;
          }
          console.log('check points');
          console.log(points);

          var length = points.length;
          var cords = [];
          var bounds = new google.maps.LatLngBounds();

          // Build a cords array from the points
          for (var key in points) {
            var point = points[key];
            cords.push(point);
            bounds.extend(new google.maps.LatLng(point.lat, point.lng));
          }
          var self = this;
          // var map = document.querySelector('google-map');
          // map.addEventListener('google-map-ready', function(e) {
          //   console.log('Map loaded!');
          // });
          // console.log('map instance on ready');
          // map = new google.maps.Map(document.getElementById('map'),{});
          // console.log(map);
          // map.addEventListener('google-map-ready', function(e) {
          //   console.log('Map loaded!');
          // });
          console.log('final cords');
          console.log(cords);
             try{
               self._mapPolyline = new google.maps.Polyline({
                 path: cords,
                 geodesic: true,
                 strokeColor: '#009FDD',
                 strokeOpacity: 1.0,
                 strokeWeight: 2
               });

               // Draw the route line
               console.log(self._map)
               self._mapPolyline.setMap(self._map);
               self._map.fitBounds(bounds);


               google.maps.event.addListener(self._mapPolyline, 'mouseup', function(event){
                 if(!self._isDragging){
                   self._moveMarker(event.latLng);
                 }
               });
             }catch(err){
               console.log('map specific error');
               console.log(err);
               // console.log(map);
               // console.log('element');
               // console.log(self.$.map)
               // map = new google.maps.Map(self.$.map, {});
             }
        },

        /**
         * Method to move the marker
         * Move the marker to the closest point based on the click position
         * and seek the video to point's second
         * @param latLng Object with latitude and longitude of the click
         */
        _moveMarker : function(latLng){
          var point = this.$.mapsUtils.getClosestPoint(latLng.lat(), latLng.lng(), this._routeDetails.videoGeoPoints);
          this._currentLat = point.latLng.lat;
          this._currentLng = point.latLng.lng;
          this.player.currentTime(point.key);
          this._nextStop = this._calculateNextStop(this._stopsSlot, point.key);
        },

        _onYoutubeReady: function() {
          this._adjustMapSize();
        },

        getRouteSlot: function(videoGeoPoints, departurePointKey, destinationPointKey) {
          var slotVideoPoints = {};

          for (var indexPoint = departurePointKey; indexPoint <= destinationPointKey; indexPoint++) {
            if (videoGeoPoints[indexPoint]) {
              slotVideoPoints[indexPoint] = videoGeoPoints[indexPoint];
            }
          }

          return slotVideoPoints;
        },

        _adjustMapSize : function(){
          var self = this;
          if(!this.code){
            return;
          }
          console.log('Map Getting Adjusted');
          if(!this._mapsApiLoaded){
            return;
          }
          var mapHeight;

          console.log('player height');
          // console.log(this.$.mainRouteVideo);
          console.log(this.$.mainRouteVideo.offsetHeight);

          // Check if the device is in landscape or is a high resolution screen to resize the google map to the same size that the map
          if (window.matchMedia("(min-width: 361px) and (orientation: landscape)").matches) {
            mapHeight = this.$.mainRouteVideo.offsetHeight;
          } else {
            // Calculate the map height
            mapHeight = this.$.mainRouteVideo.offsetHeight;//this._calculateMapHeight();
          }

          if(mapHeight<=0){
            mapHeight = $('.video-player-wrapper').find('video').height();
            console.log('From Dom: '+mapHeight);
            if(mapHeight<=0){
              mapHeight = $('.video-player-wrapper').height();
              if(!mapHeight){
                  mapHeight = 450;
                  setTimeout(function(){
                     self._adjustMapSize();
                  }, 1000);
              }
            }
            console.log('Final Map Height: '+mapHeight);
          }
          this.$.map.style.height = mapHeight+ 'px';
          this.$.map.style.minHeight = mapHeight+ 'px';
          google.maps.event.trigger(this._map, 'resize');
        },

        _enableNextStop: function() {
          if(this.$.nextStopMarker){
              this.$.nextStopMarker.hidden = false;
          }

          this.$.stopVideo.disabled = false;
        },

        _disableNextStop: function() {
            if(this.$.nextStopMarker){
                this.$.nextStopMarker.hidden = true;
            }

          this.$.stopVideo.disabled = true;
        },

        _calculateNextStop: function(stopsSlot, videoCurrentTime) {
          // Get the next stop according to the actual time
          var nextStopOrigin = this._getNextStop(stopsSlot, videoCurrentTime);
          if(!nextStopOrigin){
            return ;
          }
          if(!nextStopOrigin.sec){
            return ;
          }
          var nextStopSec = parseInt(nextStopOrigin.sec);
          var nextStop = {
            lat: nextStopOrigin.lat,
            lng: nextStopOrigin.lng,
            name: nextStopOrigin.name,
            route_list:nextStopOrigin.route_list,
            sec: nextStopSec - this.SECONDS_INTERVAL_FOR_STOPS,
            endSec: nextStopSec + this.SECONDS_INTERVAL_FOR_STOPS
          };

          this._disableNextStop();

          return nextStop;
        },

        _getNextStop: function(stops, currentTime) {
          if (stops && stops.length > 0) {
            var nextStop = stops[0];

            if (stops.length > 1) {
              for (var indexStop = 1; indexStop < stops.length; indexStop++) {
                if (parseInt(stops[indexStop].sec) > currentTime) {
                  return stops[indexStop];
                }
              }
            }
          }
        },

        _poisLoaded: function(event) {
          this._pois = event.detail;
        },

        _onPoiClick : function(e){
          if(this._selectedPoiMarker){
            this._selectedPoiMarker.open = false;
          }

          this._selectedPoiMarker = e.srcElement;
        },
        _onStopIconClick : function(e){
          console.log('check stop click even');
          console.log(e);;
          var sourceElement = e.srcElement;
          var sec = sourceElement.childNodes[1].innerText;
          console.log('clicked station sec: '+sec);
          if(sec){
              this.player.currentTime(sec);
          }
          this._onPoiClick(e);

          //this._selectedPoiMarker = e.srcElement;
        },

        _selectedPoiChange: function(newSelectedPoi) {
          if (newSelectedPoi) {
            var getDetailsPromise = this.$.search.getDetails(newSelectedPoi.place_id);
            var self = this;

            getDetailsPromise.then(function(data) {
              self._selectedPoiDetails = data;

              // When is mobile hide the poi list and show the poi details
              if(!self.isDesktop){
                page(page.current + "/detail");
              }
            }).catch(function(error) {
              console.log(error)
            });

            // Send the event to Google Analytics
            ga('send', 'event', 'POI', 'selected', newSelectedPoi.name);
          }
        },

        showTour : function(){
          this._selectedPoi = null;
          this._selectedPoiDetails = null;
          this.$.poiDetails.classList.remove('active');
          this.$.pois.classList.remove('active');
        },

        showPois : function(){
          this.$.poiDetails.classList.remove('active');
          this.$.pois.classList.add('active');
          if(this.isDesktop){
            this.$.poiDetails.classList.add('active');
          }
          app.condenseHeader();
        },

        showPoiDetails : function(){
          this.$.poiDetails.classList.add('active');
          this.$.pois.classList.remove('active');
          app.condenseHeader();
        },

        /**
         * Goes back to the navigation page when its on poi list or poi details
         */
        _back : function(){
          if(page.current.indexOf('/pois') != -1){
            var navPage = page.current.replace("/detail" , "");
            navPage = navPage.replace("/pois", "");
            if(page.current.indexOf('/detail') != -1){
              page.back(navPage);
            }
            page.back(navPage);
          }
        },
        reAlightElements: function(){

          // console.log('Resizing fullscreen button');
          // var fullSkinButton = document.querySelector('.video-js .vjs-fullscreen-control');
          // fullSkinButton.style.display = 'block';
          // var videoHeight = parseInt($('video').outerHeight() || $('video').height());
          // fullSkinButton.style.marginTop = '-'+(videoHeight * .9290)+'px';//'-57.5%';
          // fullSkinButton.style.position = 'relative';
          // fullSkinButton.style.fontSize = '17px';
        },
        _bingVideo:function(src){
            if(!videojs){
              return;
            }

              var options = {
                  //aspectRatio:'20:20'
                  //controls:false
                  fluid:true
              };
              var self = this;
               this.player = videojs(self.$.mainRouteVideo, options, function onPlayerReady() {
                videojs.log('Your player is ready!');
                var playButton = document.querySelectorAll('.video-js button');
                for (var i = 0; i < playButton.length; i++) {
                  playButton[i].style.display = 'none';
                }
                self.reAlightElements();
                $('.fullscreen-button').on('click',function(){
                  $('.video-js .vjs-fullscreen-control').click();
                });

                var progressBar = document.querySelector('.video-js .vjs-progress-control');
                progressBar.style.visibility='hidden';
                var timeRemaing = document.querySelector('.vjs-remaining-time-display');
                timeRemaing.style.visibility='hidden';
                timeRemaing.style.display='none';
                var controllBar = document.querySelector('.video-js .vjs-control-bar');
                controllBar.style.backgroundColor = 'transparent';
                self._adjustMapSize();
                window.addEventListener("resize", function(){
                  self._adjustMapSize();
                  self.reAlightElements();
                });
                setTimeout(function(){
                     self._adjustMapSize();
                }, 2000);
                setTimeout(function(){
                     self._adjustMapSize();
                }, 4000);
                var screenEvent = document.querySelector('.vjs-tech');
                if(screenEvent){
                  screenEvent.style.pointerEvents = 'none';
                }



                //self.player.src({type: "video/mp4", src: "https://s3-us-west-1.amazonaws.com/vta-tour-rtmp/ALUMROCKTRANSITCENTER-SANTACLARA%2628TH/1024x1024-SANTA_CLARA_28TH-ALUM_ROCK_TRANSIT_CENTER.mp4"});

                // In this context, `this` is the player that was created by Video.js.
                if(src){
                  self.player.src({type: "video/mp4", src: src});
                }
                //self.player.pause();
                self._shouldHidePlay = false;
                videojs.log('Paused now');

                // How about an event listener?
                self.player.on('ended', function() {
                  videojs.log('Awww...over so soon?!');
                  self._endVideo();
                  self._adjustMapSize();
                });
                self.player.on('play', function() {
                  console.log('Video Played');
                  self._playVideo();
                  self._adjustMapSize();
                  self.reAlightElements();
                });
                self.player.on('pause', function() {
                  console.log('Video Paused');
                  self._pauseVideo();
                  self._adjustMapSize();
                });
                self.player.on('error', function(e) {
                  console.log('Video error');
                  console.log(e);
                });
                  self.player.on('fullscreenchange', function() {
                    //alert('resized')
                    console.log('full screen event');
                    self._adjustMapSize();
                    self.reAlightElements();
                  });

                self.player.on('timeupdate', function () {
                    //console.log(this.currentTime());
                  self._videoCurrentTimeChange(parseInt(this.currentTime()));
                  self.reAlightElements();
                });
              });

          console.log('done')

        },
        _assignSource : function(src){
          if(this.player){
            this.player.src({type: "video/mp4", src: src});
            var self = this;
            this._adjustMapSize();
            setTimeout(function(){
               self._adjustMapSize();
            }, 2000);

          }else{
            this._bingVideo(src);
          }
        },
        _videoViewChange:function(src){
          // console.log('video direction change');
          // console.log(this.$.videoViewSelection.value);
          // this._assignSource(this.$.videoViewSelection.value);
          // this._videoCurrentTimeChange(0);
          // this._pauseVideo();
          this._assignSource(src);
          this._videoCurrentTimeChange(0);
          this._pauseVideo();
        },
        _goBack:function(){
          $('#backBtn').click();
        },
        ready: function() {
          var self = this;
          setTimeout(function(){
            self._bingVideo()
          }, 1000);

          $(document).ready(function(e){
            $('.SelectViewItems').hide();
            $('.SelectViewItems').on('click',function(e){
              var videoSource = $(this).attr('data-video');
              $('#viewSelectionText').text($(this).find('a').text());
              self._videoViewChange(videoSource);
            });
            // $('.paper-progress-0 #primaryProgress.paper-progress').css({
            //   'background':'#44B5E3',
            //   'height':'20px'
            // })

          })
        },
        _isValidCords:function(lat,lng){
          if(isNaN(parseFloat(lat))){
            return false;
          }
          if(isNaN(parseFloat(lng))){
            return false;
          }
          return true;
        },
        _isInValidRange:function(sec){
          if(sec>=this._videoStartTime && sec<=this._videoEndTime){
            return true;
          }
          return false;
        },
        _getStopIcon:function(){
          return new google.maps.MarkerImage(
           '/images/fa-map-marker-stop.png', //url
           null, //size
           null, //origin
           null, //anchor
           new google.maps.Size(15, 15)
          );
        },
        _calculateValidZooomStatus:function(){
          if(this._map.getZoom() >= 14){
            this._isValidZoom = true;
          }else{
            this._isValidZoom = false;
          }
        },
        _getDirectionData: function(startLat,endLatLng) {
          var directionsService = new google.maps.DirectionsService();
          var start = startLat;
          var end = endLatLng;
          var request = {
            origin: start,
            destination: end,
            travelMode: 'DRIVING'
          };
          var self = this;
          directionsService.route(request, function(result, status) {
            if (status == 'OK') {
              console.log('check experimental direction data below');
              console.log(result);
              //directionsDisplay.setDirections(result);
              if(result){
                if(result.routes && result.routes.length){
                    if(result.routes[0].legs && result.routes[0].legs.length){
                        if(result.routes[0].legs[0].steps && result.routes[0].legs[0].steps.length){
                          var directionData = result.routes[0].legs[0].steps && result.routes[0].legs[0].steps[0];
                          var instruction = directionData.instructions;
                          if(instruction){
                            instruction = instruction.replace('Head','Heading');
                            var instructionArray = instruction.split("<div");
                            instruction = instructionArray[0];
                          }
                          if(directionData.maneuver){
                             instruction = instruction +' ('+directionData.maneuver+')';
                          }
                          $('#direction-display').html(instruction);
                        }
                    }
                }
              }
            }
          });

          //this.$.search.getDetails(newSelectedPoi.place_id);

        },
        _toggleDirectionNavigation:function(){
          this._direction = this._direction ? false:true;
        }
      });
    }catch(err){
      console.log('route navigation error');
      console.log(err);
    }

  })();
</script>
