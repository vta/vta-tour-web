<dom-module id="training-quiz">
    <template>
      <style is="custom-style" include="shared-styles"></style>
      <style>
        paper-dropdown-menu {
          width: 100%;
        }

        .route-selection-message {
          color: var(--secondary-color);
          margin-left: 26%;
          margin-top: 1%;
        }

        paper-fab{
          float: left;
          position: relative;
          margin-left: 44%;
          margin-top: 10px;
          width:135px;
          background-color: #02528a;
          border-radius: 29px;
          touch-action: manipulation;
          -ms-touch-action: manipulation;
          cursor: pointer;
          font-weight: 600;
          text-align: center;
          height: 45px;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          background-image: none;
          box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(2, 82, 138, 0.19);
        }
        .panel-body {
          padding: 10px!important;
          border-radius: 10px!important;
          background-color: #FFF!important;
          box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(2, 82, 138, 0.19);
          margin-top: 16px;
          width: 86%;
          margin-left: 14%!important;
        }
        paper-input-autocomplete,paper-dropdown-menu{
          border: 1px solid #02528a!important;
          box-shadow: none;
          /* color: #c2c2c2; */
          padding: 1px 32px;
          font-size: 11px;
          border-radius: 60px!important;
        }
        paper-material{
          width:88%;
        }
        /* paper-dropdown-menu{
          padding: 5px!important;
          border-radius: 21px!important;
          background-color: #FFF!important;
          box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(2, 82, 138, 0.19) !important;
          margin-top: 16px;
          border: 1px solid #02528a!important;
          height: 60px;
        } */
        @media all and (min-width: 768px) and (max-width: 980px) {
          .panel-body {
            width: 85%;
            margin-left: 10%;
          }
          .route-selection-message {
            margin-left: 20%;
          }
        }
        @media all and (max-width: 768px) {
          .panel-body {
            width: 85%;
            margin-left: 10%;
          }
          .top-header{
            height: 39px!important;
          }

          paper-fab{
            margin-left: 40%;
            margin-top: 30px;
          }
          .route-selection-message {
            margin-left: 15%;
          }
          .quiz-area {
            padding-left: 5%!important;
            padding-right: 5%!important;
        }


        }

        @media (max-width: 480px) {
          .panel-body {
            width: 100%;
            margin-left: 0%;
          }
          .top-header{
            height: 39px!important;
          }
            paper-fab{
              margin-left: 38%;
              margin-top: 30px;
            }
            .route-selection-message {
              margin-left: 10%;
            }

        }
        @media (max-width:320px) {

              .panel-body {
                width: 100%;
                margin-left: 0%;
              }

        }
        .header-frontend .navbar{
              min-height: 52px !important;
        }
        .dataTables_info {
            color: #fff!important;
            margin-top: 38px!important;
        }


        .f-box i {
            font-size: 25px;
            line-height: normal;
            margin-top: 27px;
            display: block;
            color: #fff;
        }

        .dataTables_info {
            color: #fff!important;
            margin-top: 8px;
        }

        .f-box {

            height: 104px!important;

        }
        @media (max-width: 768px){

        	.top-header .header-item {

             margin-left:0px!important;
        ;
            /* padding-top: 4px; */
        }
        .top-header {

            height:36px!important;
            padding-left: 15px;
            padding-right: 15px;
        }
      }

      .training-quiz h3{ font-size:21px !important; color:#02528a!important; font-weight: 345}
      .training-quiz{ padding-bottom:1px;}
      .background-color,.background-color .training-quiz{
        padding-bottom:0px;
      }
      .quiz-area{ padding-left:1%!important; padding-right:10%!important; }
      .quiz2{ line-height:33px!important;}
      .inner-content{
        padding-bottom: 1px !important;
        margin: 2px 0px !important;
      }
      .training-quiz.training-quiz h3.training-quiz{
            padding-top: 20px;
      }
      .f-box{
        cursor: pointer;
      }
      #saveOperationResultModal {
        width: auto;
        background-color: transparent;
        color: var(--vta-white);
        box-shadow: none;
      }

      #saveOperationResultModal .icon {
        text-align: center;
      }

      #saveOperationResultModal iron-icon {
        width: 140px;
        height: 140px;
        padding: 20px;
        text-align: center;
        -webkit-border-radius: 50%;
        border-radius: 50%;
      }

      #saveOperationResultModal .message-wrapper.success iron-icon {
        background-color: var(--primary-color);
      }

      #saveOperationResultModal .message-wrapper.error iron-icon {
        background-color: var(--secondary-color);
      }

      #saveOperationResultModal .message {
        text-align: center;
        font-size: 2.5em;
        line-height: 1;
        text-transform: none;
        font-weight: bold;
        margin-top: 10px;
      }
      .special-messge{
        padding: 2px!important;
        border-radius: 10px!important;
        background-color: #FFF!important;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(2, 82, 138, 0.19);
        margin-top: 10px;
        width: 61%;
        margin-left: 20%!important;
        text-align: center;
      }

      .banner{
        height: auto;
        position: relative;
        overflow: auto;
        margin-bottom: 0.5%;
      }
      /*  Extra Media queries */

      @media all and (min-width: 768px) and (max-width: 980px) {

      }
      @media all and (max-width: 768px) {

        }
      @media (max-width: 480px) {
            .panel-body{
              margin-left: 5%!important;
            }
            .training-quiz h3{
              font-size: 15px !important;
            }
            .quiz2{
                  line-height: 20px!important;
            }

            .f-box{
              padding:0px!important;
              padding-top:5%!important;
              height: 60px!important;
              margin-top: 10px !important;
            }
            .f-box i {
                margin-top: 10px !important;
            }
            .f-box h2{
              font-size: 10px!important;
            }
            .dataTables_info{
                  margin-top: 15px!important;
            }
        }
        .background-color{
          /* margin-top: 7%; */
          position: fixed;
          bottom: 0;
        }
        google-map {
          height: 300px;
        }
      </style>
      <firebase-document
        app-name="vta"
        id="routeDataProcessing">
      </firebase-document>
      <div class="top-header">
              <div class="container-fluid header-area">
                  <div class="pull-left">

                      <div style="height:30px;" class="header-item">Training</div>

                  </div>
                  <div class="pull-right  ">


                  </div>
                  <!-- #top-social end -->

              </div>

      </div>

      <div class="inner-content">
        <template is="dom-if" if="[[!_qa.length]]">
          <div class="special-messge">
            <h3>Preparing Training Q&A Please wait.....<iron-icon icon="icons:hourglass-empty"></iron-icon></h3>
          </div>
        </template>
        <template is="dom-if" if="[[_allQuestionAnswered]]">
          <div class="special-messge">
            <h3>Thanks for completing quiz, you can review your answers below or go to main screen and continue exploring different routes</h3>
          </div>
        </template>

        <div class="quiz_content" hidden$="{{!_qa.length}}">
          <section class="banner">
          <div class="container quiz-area">
          	<div class="panel-body style-scope training-quiz">
            <div class="col-md-6 col-xs-12">
              <!-- <template is="dom-if" if="[[_currentQA.lat]]"> -->
              <route-map id="routeMap" geo-points="{{_currentQA.geoPoints}}"></route-map>
              <!-- <google-map
                api-key="AIzaSyCRa-TDLoCJRQmekLjUiU5tI9HXnWijLu4"
                additional-map-options='{"zoomControl":"true"}'
                latitude="[[_currentQA.lat]]"
                longitude="[[_currentQA.lng]]"
                mapType="satellite"
                zoom="15"
                >
              </google-map> -->
              <!-- </template> -->
            </div>
            <div class="col-md-6 col-xs-12">
                    <div class="style-scope training-quiz">
                      <h3 class="style-scope training-quiz">Q[[_getQuestionNumber(_currentQAIndex)]]: [[_currentQA.questionText]]</h3>
                      <div class="style-scope training-quiz">
                        <template is="dom-repeat" items="[[_currentQA.options]]" as="optionItem" >
                          <span class="style-scope training-quiz quiz2">
                              <input id="answer_option_[[index]]" name="optionAnswer" type="radio" value="[[index]]" class="optionAnswer clearAbleCheck"/> [[optionItem.name]]
                          <!-- <template is="dom-if" if="[[optionItem.isCorrect]]">
                               <span> -- Right Answer</span>
                          </template> -->
                          <template is="dom-if" class="style-scope training-quiz"></template>
                          </span>
                          <br class="style-scope training-quiz">
                        </template>
                      </div>
                      </div>
                </div>
              <div class="clearfix"></div>
            </div>
           </div>
         </section>

         <div id="spacer_div" clss="spacer_div"><br/></div>
         <div id="spacer_div_2" clss="spacer_div"><br/></div>
         <div id="spacer_div_3" clss="spacer_div"><br/></div>
         <div id="spacer_div_4" clss="spacer_div"><br/></div>


            <!--container start-->
            <div class="background-color">
            <div class="container">
                <div class="row">
                    <!--feature start-->
                    <div class="button-area">
                    <div class="col-lg-4 col-sm-4 col-xs-4 icon">
                        <section>
                            <div class="f-box" on-click="_showPreviousAnswer">
                                <i><img style=" width:30px;" src="../../images/back02.svg" alt=""></i>

                            </div>

                        </section>
                    </div>
                    <div class="col-lg-4 col-sm-4 col-xs-4 icon">
                        <section>
                            <div class="f-box">
                              <div class="dataTables_info" id="sample_1_info">Showing [[_getQuestionNumber(_currentQAIndex)]] of [[_qa.length]] entries</div>
                            </div>

                        </section>
                    </div>
                    <div style=" border-right:1px solid #fff" class="col-lg-4 col-sm-4 col-xs-4 icon" >
                        <section>
                            <div class="f-box" on-click="_checkAnswer">
                                 <i><img style=" width:30px;" src="../../images/right-arrow.svg" alt=""></i>

                            </div>

                        </section>
                    </div>
                    </div>
                    <!--feature end-->
                </div>

            </div>
          </div>

        </div>

    <!-- <template is="dom-if" if="[[_qa.length]]">
      <template is="dom-repeat" items="[[_qa]]" as="qaItem" >
        <div class="panel-body">
            <div>
              <h3>Q[[_getQuestionNumber(index)]]: [[qaItem.questionText]]</h3>
              <div>
              <template is="dom-repeat" items="[[qaItem.options]]" as="optionItem" >
                  <span>[[_getQuestionNumber(index)]]) [[optionItem.name]]
                  <template is="dom-if" if="[[optionItem.isCorrect]]">
                       <span> -- Right Answer</span>
                  </template>
                  </span>
                    <br/>
              </template>

              </div>
            </div>

        </div>
      </template>
    </template> -->


        <!-- <template is="dom-if" if="{{_sameStops}}">
          <div class="route-selection-message">
            Please select different departure and destination stops to start the tour.
          </div>
        </template> -->
      </div>

      <!-- <paper-fab id="viewRide" label="View Route" raised disabled on-click="_onGoClick"></paper-fab> -->

      <paper-dialog id="saveOperationResultModal" modal>
        <template is="dom-if" if="{{_operationSuccess}}">
          <div class="message-wrapper success">
            <div class="icon">
              <iron-icon icon="icons:check"></iron-icon>
            </div>
            <div class="message">{{_operationMessageDetail}}</div>
          </div>
        </template>
        <template is="dom-if" if="{{!_operationSuccess}}">
          <div class="message-wrapper success">
            <div class="icon">
              <iron-icon icon="icons:close"></iron-icon>
            </div>
            <div class="message">{{_operationMessageDetail}}</div>
          </div>
        </template>
      </paper-dialog>
      <maps-utils id="mapsUtils"></maps-utils>
    </template>

</dom-module>

<script>
	(function() {
    'use strict';
    Polymer({
      is: 'training-quiz',

      properties: {
        _qa: {
          type: Array,
          value: []
        },
        _currentQA:{
            type: Object,
        },
        _currentQAIndex:{
            type: Number,
        },
        _allQuestionAnswered:{
          type: Boolean,
        }
      },

      _generateQASet:function(processedRoutes){
        var qa = [];
        console.log('Received routes to create qa');
        var shuffleArray = function (array) {
              for (var i = array.length - 1; i > 0; i--) {
                  var j = Math.floor(Math.random() * (i + 1));
                  var temp = array[i];
                  array[i] = array[j];
                  array[j] = temp;
              }
              return array;
          }
        console.log(processedRoutes);
        for(var index in  processedRoutes){
          var tempQuizItem = {};
          var tempRoute = processedRoutes[index];
          var direction = Math.random() < 0.5 ? 'a' : 'b';
          var questionType =  Math.floor(Math.random() * 2) + 1;
          console.log('Direction: '+ direction);
          console.log('question type:'+ questionType);
          var directionName = "";
          console.log(tempRoute);
          if(direction=='a'){
            directionName = tempRoute.directionAName;
          }else{
            directionName = tempRoute.directionBName;
          }
          var question = ""
          var answer = null;
          var options = [];

          var existingRouteListRelatedQuestion = 0;
          var existingDirectionRelatedQuestion = 0;
          var existingStopPositionRelatedQuestion = 0;

          // for(var i=0;i<qa.length;i++){
          //   if(qa.)
          // }



          if(questionType<=1){
            var randomStopSelection = Math.floor(Math.random() * (tempRoute.routeDetails[direction].stops.length - 2)) + 1;
            if(randomStopSelection>=tempRoute.routeDetails[direction].stops.length){
              randomStopSelection = randomStopSelection -1;
            }
            question = "What is the next stop after "+tempRoute.routeDetails[direction].stops[randomStopSelection].name+" on "+ tempRoute.name + " "+directionName + " bound";

            answer = randomStopSelection +1;
            var answerStop = tempRoute.routeDetails[direction].stops[answer];
            console.log(answer);
            console.log('total length: '+tempRoute.routeDetails[direction].stops.length);
            answerStop.isCorrect = true;
            options.push(answerStop);
            var arr = [answer];
            var length = tempRoute.routeDetails[direction].stops.length >4?4:tempRoute.routeDetails[direction].stops.length;
            while(arr.length < length){
                var randomnumber = Math.floor(Math.random()*tempRoute.routeDetails[direction].stops.length) + 1;
                if(arr.indexOf(randomnumber) > -1 && randomnumber !=randomStopSelection) continue;
                console.log('random number: '+randomnumber);
                if(tempRoute.routeDetails[direction].stops[randomnumber] && tempRoute.routeDetails[direction].stops[randomnumber].name !=answerStop.name){
                  arr[arr.length] = randomnumber;
                  options.push(tempRoute.routeDetails[direction].stops[randomnumber]);
                }
            }

          }else{
            var randomStopSelection = Math.floor(Math.random() * (tempRoute.routeDetails[direction].stops.length - 1)) + 1;
            question = "What is the stop before "+tempRoute.routeDetails[direction].stops[randomStopSelection].name+" on "+ tempRoute.name + " "+directionName + " bound";
            answer = randomStopSelection -1;
            console.log(answer);
            console.log('total length: '+tempRoute.routeDetails[direction].stops.length);
            var answerStop = tempRoute.routeDetails[direction].stops[answer];
            answerStop.isCorrect = true;
            console.log(answer);
            console.log('total length: '+tempRoute.routeDetails[direction].stops.length);
            options.push(answerStop);
            var arr = [answer];
            var length = tempRoute.routeDetails[direction].stops.length >4?4:tempRoute.routeDetails[direction].stops.length;
            while(arr.length < length){
                var randomnumber = Math.floor(Math.random()*tempRoute.routeDetails[direction].stops.length) + 1;
                if(arr.indexOf(randomnumber) > -1 && randomnumber !=randomStopSelection) continue;
                console.log('random number: '+randomnumber);
                if(tempRoute.routeDetails[direction].stops[randomnumber] && tempRoute.routeDetails[direction].stops[randomnumber].name !=answerStop.name){
                  arr[arr.length] = randomnumber;
                  options.push(tempRoute.routeDetails[direction].stops[randomnumber]);
                }
            }
          }
          var questionAnswerObject = {
            questionText:question,
            answerIndex : answer,
            options:shuffleArray(options),
            mainRoute:tempRoute,
            direction:direction,
            quesrtionType:'stop_position_related',
            lat:answerStop.lat,
            lng:answerStop.lng,
            geoPoints:tempRoute.routeDetails[direction].videoGeoPoints
          }
          qa.push(questionAnswerObject);
        }

        this._qa = shuffleArray(qa);
        console.log('Final QA');
        console.log(this._qa);
        this._currentQAIndex = 0;
        this._currentQA = this._qa[this._currentQAIndex];
        this._setMapFocus();
      },
      _combineRouteAndRouteDetails: function(routes,routeDetailses){
        var finalRoutes = [];
        // console.log('routes parameter');
        // console.log(routes);
        // console.log('Route Detailses parameter');
        // console.log(routeDetailses);
        for (var routeKey in routes) {
          var tempRoute = routes[routeKey]
              if(tempRoute){
                console.log(tempRoute.code);
                if(routeDetailses && routeDetailses[routeKey] && routeDetailses[routeKey].a && routeDetailses[routeKey].a.stops && routeDetailses[routeKey].b && routeDetailses[routeKey].b.stops){
                  tempRoute.routeDetails = routeDetailses[routeKey];
                  finalRoutes.push(tempRoute);
                }
              }
        }
        console.log('Final Routes Data');
        console.log(finalRoutes);
        //randomly selecting 10 routes
        var arr = [];
        var ranDomRoutes = [];
        while(arr.length < 10){
            var randomnumber = Math.floor(Math.random()*finalRoutes.length) + 1;
            if(arr.indexOf(randomnumber) > -1) continue;
            console.log('random number: '+randomnumber);
            if(finalRoutes[randomnumber]){
              arr[arr.length] = randomnumber;
              ranDomRoutes.push(finalRoutes[randomnumber]);
            }
        }
        this._generateQASet(ranDomRoutes);
        // console.log('uniqure routes selected for question');
        // console.log(ranDomRoutes);
      },
      _getQuestionNumber : function(index){
         return parseInt(index)+1;
      },
      ready: function() {
        this._allQuestionAnswered = false;
        var self = this;
        var routes = [];
        var routesDetailses = [];
         this.$.routeDataProcessing.getStoredValue('/routes')
           .then(function(data) {
             // console.log('Rotues Data');
             // console.log(data);
             // console.log(data.length);
             routes = data;
             self.$.routeDataProcessing.getStoredValue('/route-details')
               .then(function(data) {
                 // console.log('Rotue Details Data');
                 // console.log(data);
                 routesDetailses = data;
                 self._combineRouteAndRouteDetails(routes,routesDetailses);
               }).catch(function(error) {
                 console.log(error);
               });
           }).catch(function(error) {
             console.log(error);
           });
      },
      _showOperationResultModal: function(isSuccess, operationDetailMessage) {
        this.$.saveOperationResultModal.open();
        var self = this;
        this._operationSuccess = isSuccess;
        this._operationMessageDetail = operationDetailMessage;
      },
      _closeOperationResultModal: function() {
        this.$.saveOperationResultModal.close();
      },
      _showPreviousAnswer:function(e){
        if(this._currentQAIndex<=0){
          return false;
        }{
          this._currentQAIndex -= 1;
        }

        this._currentQA = this._qa[this._currentQAIndex];
        this._setMapFocus();
        console.log(this._currentQA);
        for(var i=0;i<this._currentQA.options.length;i++){
          if(this._currentQA.options[i].isCorrect==true){
              $('#answer_option_'+i).prop('checked', true);
          }
        }
        //alert(this._currentQA.alreadyAnswered)
      },
      _checkAnswer:function(e){
        var self = this;
        console.log('it is working');
        var answer = $("input:radio.optionAnswer:checked");
        console.log(answer);
        if(!answer.length){
          console.log('Please select answer');
          this.$.saveOperationResultModal.close();
          this._showOperationResultModal(false,"Please select an answer");
          setTimeout(function(){
             self.$.saveOperationResultModal.close();
          }, 1000);
        }
        var answerIndex = answer.val();
        if(this._currentQA.options[answerIndex]){
          console.log('check below');
          console.log(this._currentQA.options[answerIndex]);
          if(this._currentQA.options[answerIndex] && this._currentQA.options[answerIndex].isCorrect===true){

            console.log('Current Index: '+this._currentQAIndex +' qa length: '+this._qa.length);
              this._currentQAIndex += 1;
            console.log('Next Index: '+this._currentQAIndex +' qa length: '+this._qa.length);
            if(!this._currentQA.alreadyAnswered){
              this._qa[this._currentQAIndex-1].alreadyAnswered = true;
              if(this._currentQAIndex>=this._qa.length){
                  this._showOperationResultModal(true,"All questions answered");
                  setTimeout(function(){
                     self.$.saveOperationResultModal.close();
                  }, 1000);
                  this._allQuestionAnswered = true;
                  this._currentQAIndex -= 1;
                  return false;
              }
              console.log('Correct Answer, moving to next question');
              this._showOperationResultModal(true,"Correct answer, moving to next question");
              setTimeout(function(){
                 self.$.saveOperationResultModal.close();
              }, 1000);
            }
            this._currentQA = this._qa[this._currentQAIndex];
            if(this._currentQA){
                $('.clearAbleCheck').prop('checked', false);
            }else if(this._allQuestionAnswered){
              this._currentQAIndex = this._qa.length - 1;
              this._currentQA = this._qa[this._currentQAIndex];
              this._showOperationResultModal(true,"All questions answered");
              setTimeout(function(){
                 self.$.saveOperationResultModal.close();
              }, 1000);
            }
            this._setMapFocus();
            if(this._currentQA && this._currentQA.alreadyAnswered){
              for(var i=0;i<this._currentQA.options.length;i++){
                if(this._currentQA.options[i].isCorrect==true){
                    $('#answer_option_'+i).prop('checked', true);
                }
              }
            }
          }else{
            console.log('Wrong Answer, please try again');
            this.$.saveOperationResultModal.close();
            this._showOperationResultModal(false,"Wrong answer, Please select the correct answer");
            var self = this;
            setTimeout(function(){
               self.$.saveOperationResultModal.close();
            }, 1000);
          }
        }
      },
      _setMapFocus:function(){
        var lat = this._currentQA.lat;
        var lng = this._currentQA.lng;
        var zoomLevel = 15;
        var self = this;
        if(self.$.routeMap){
          self.$.routeMap._setMapFocusAndZoom(lat,lng,zoomLevel);
        }
      }

    });
  })();
</script>
